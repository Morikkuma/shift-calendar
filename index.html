<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‹¤å‹™ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ v1.65 (å®Œå…¨çµ±åˆç‰ˆ)</title>
    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #777777;
            --primary-work: #a7d7c5;      
            --primary-work-dark: #7fb5a1; 
            --accent-off: #ffb7b2;        
            --accent-public-off: #ef5350; 
            --accent-off-dark: #e08e89;
            --accent-leave: #ffb74d;      
            --accent-leave-dark: #f57c00;
            --accent-wish: #b71c1c;       
            
            --status-error-bg: #ffebee;
            --status-error-text: #c62828;
            --status-warn-bg: #fff3e0;
            --status-warn-text: #e65100;
            --status-ok-bg: #e8f5e9;
            --status-ok-text: #2e7d32;
            --status-sync-bg: #e3f2fd;
            --status-sync-text: #1565c0;
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-fab: 0 6px 12px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; 
            padding: 0;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100dvh;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            width: 100%; max-width: 600px;
            background-color: var(--card-bg); 
            display: flex; flex-direction: column; position: relative;
            min-height: 100dvh;
            box-shadow: var(--shadow-md);
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        .header { 
            padding: 12px 16px; 
            background-color: #fff; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #f0f0f0;
            position: sticky; top: 0; z-index: 10;
        }
        .title-group { text-align: center; flex-grow: 1; display: flex; flex-direction: column; align-items: center; }
        
        .period-label-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 2px; }
        .period-label { font-size: 1.1rem; font-weight: 700; color: var(--primary-work-dark); margin: 0; }
        
        .pattern-switch { display: flex; background-color: #f0f0f0; border-radius: 12px; padding: 2px; }
        .pattern-btn { border: none; background: transparent; padding: 4px 10px; font-size: 0.75rem; font-weight: 700; border-radius: 10px; cursor: pointer; color: #888; transition: all 0.2s; }
        .pattern-btn.active { background-color: var(--primary-work-dark); color: #fff; box-shadow: var(--shadow-sm); }

        .month-title { font-size: 0.8rem; font-weight: 500; color: var(--text-sub); margin: 0; }
        .nav-btn { background: none; border: none; cursor: pointer; width: 44px; height: 44px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--text-main); }
        
        /* åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (ãƒ˜ãƒƒãƒ€ãƒ¼å†…) */
        .sync-status-main { font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; display: inline-block; background-color: #eee; color: #666; margin-top: 4px; font-weight: 700;}
        .sync-status-main.active { background-color: var(--status-sync-bg); color: var(--status-sync-text); }
        .sync-status-main.saved { background-color: var(--status-ok-bg); color: var(--status-ok-text); }
        .sync-status-main.error { background-color: var(--status-error-bg); color: var(--status-error-text); }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ (æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) */
        .toolbar { 
            display: flex; gap: 8px; padding: 10px 16px; background-color: #fff; 
            border-bottom: 1px solid #f0f0f0; overflow-x: auto; 
            scrollbar-width: none; /* Firefox */
        }
        .toolbar::-webkit-scrollbar { display: none; } /* Chrome, Safari */
        .tool-btn { 
            flex: 0 0 auto; white-space: nowrap; padding: 8px 14px; 
            border: 1px solid #eee; border-radius: 20px; background-color: #fff; 
            font-size: 0.8rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: all 0.2s; 
        }
        .tool-btn.active-tool { background-color: #fff3e0; border-color: #ffb74d; color: #f57c00; box-shadow: inset 0 0 0 1px #ffb74d;}
        .toolbar.locked .tool-btn { opacity: 0.5; pointer-events: none; }

        /* çµ±è¨ˆã‚¨ãƒªã‚¢ */
        .stats-bar { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            padding: 10px 8px; background-color: #fff; border-bottom: 1px solid #eee; gap: 4px; overflow-x: auto; 
        }
        .stat-item { 
            display: flex; flex-direction: column; align-items: center; 
            padding: 6px 4px; border-radius: 8px; cursor: pointer; 
            border: 2px solid transparent; flex: 1; min-width: 45px; background-color: #fff; transition: all 0.2s; 
        }
        
        .stat-item[data-mode="work"] { border-color: var(--primary-work); }
        .stat-item[data-mode="wish_leave"] { border-color: var(--accent-wish); }
        .stat-item[data-mode="leave"] { border-color: var(--accent-leave); }
        .stat-item[data-mode="off"] { border-color: var(--accent-off); }
        .stat-item[data-mode="public_off"] { border-color: var(--accent-public-off); }
        
        .stat-item[data-mode="work"].active-mode { background-color: #eaf7f2; }
        .stat-item[data-mode="wish_leave"].active-mode { background-color: #ffebee; }
        .stat-item[data-mode="leave"].active-mode { background-color: #fff8e1; }
        .stat-item[data-mode="off"].active-mode { background-color: #ffebee; }
        .stat-item[data-mode="public_off"].active-mode { background-color: #ffebee; border-color: #e57373; }

        .stat-item.no-click { cursor: default; border-color: #eee; }
        .stats-bar.locked .stat-item:not(.no-click) { opacity: 0.5; border-color: transparent; }

        .stat-label-count { font-size: 0.6rem; color: var(--text-sub); font-weight: 700; white-space: nowrap; margin-bottom: 2px;}
        .stat-value { font-size: 1rem; font-weight: 700; line-height: 1; }
        .stat-work { color: var(--primary-work-dark); }
        .stat-wish { color: var(--accent-wish); }
        .stat-off { color: var(--accent-off-dark); }
        .stat-public-off { color: #d32f2f; }
        .stat-leave { color: var(--accent-leave-dark); }

        /* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .validation-header { display: flex; flex-direction: column; align-items: stretch; gap: 4px; padding: 4px 16px; background-color: #fff; }
        .total-days-display { font-weight: 700; color: var(--text-main); font-size: 0.8rem; }
        .validation-messages { padding: 0 16px 8px 16px; background-color: #fff; display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid #f0f0f0;}
        .error-message { color: var(--status-error-text); background-color: var(--status-error-bg); padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;}
        .warn-message { color: var(--status-warn-text); background-color: var(--status-warn-bg); padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding: 12px 8px 80px 8px; flex-grow: 1; align-content: flex-start; background-color: #f9f9f9;}
        .weekday { text-align: center; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 4px; font-weight: 700; }
        .weekday:nth-child(1) { color: #d32f2f; }
        .weekday:nth-child(7) { color: #1565c0; }

        .day-cell { aspect-ratio: 1/1; border-radius: 8px; background-color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 4px 2px; cursor: pointer; position: relative; font-weight: 500; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.02);}
        .day-cell.locked { cursor: default; }

        .day-cell.is-sun, .day-cell.is-holiday { color: #d32f2f !important; }
        .day-cell.is-sat { color: #1565c0; }
        .day-cell.outside-month { opacity: 0.3; background-color: #f5f5f5; box-shadow: none;}
        
        .day-cell.status-work { background-color: var(--primary-work); color: #fff; box-shadow: none;}
        .day-cell.status-leave { background-color: var(--accent-leave); color: #fff; box-shadow: none;}
        .day-cell.status-off { background-color: var(--accent-off); color: #fff; box-shadow: none;}
        .day-cell.status-public-off { background-color: var(--accent-public-off); color: #fff; box-shadow: none;}
        
        .day-cell.is-holiday, .day-cell.is-sun { font-weight: 700; }
        .day-cell.is-today { border: 2px solid var(--text-sub); }

        /* å¸Œæœ›ä¼‘ã®æ¿ƒã„èµ¤æ  */
        .day-cell.is-wish-leave { box-shadow: inset 0 0 0 3px var(--accent-wish); }

        .day-date { font-size: 0.8rem; font-weight: 700; margin-bottom: 1px; }

        .nobori-mark { margin-left: 2px; font-size: 0.6rem; color: #4a4a4a; font-weight: normal; }
        .day-cell[class*="status-"] .nobori-mark { color: #fff; }
        .day-cell.is-holiday .nobori-mark, .day-cell.is-sun .nobori-mark { color: #d32f2f; }

        .holiday-name { font-size: 0.45rem; line-height: 1.1; margin-top: 1px; text-align: center; color: #d32f2f; font-weight: 400; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .status-label { font-size: 0.6rem; font-weight: 700; margin-top: 1px; }
        
        /* ãƒ¡ãƒ¢ã¯ã‚¢ã‚¤ã‚³ãƒ³åŒ– */
        .note-indicator { font-size: 0.75rem; margin-top: 1px; }

        .warning-icon { position: absolute; bottom: 2px; right: 2px; font-size: 0.8rem; color: #ff9800; text-shadow: 0 1px 2px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.8; } }

        /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç·¨é›†ã‚¹ã‚¤ãƒƒãƒ (å³ä¸‹å›ºå®š) */
        .floating-edit-switch {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 900;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border-radius: 30px;
            box-shadow: var(--shadow-fab);
            padding: 4px;
            display: flex;
            border: 1px solid #e0e0e0;
        }
        .fab-btn {
            padding: 10px 16px; border-radius: 20px; border: none; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: all 0.2s; color: #888; background: transparent; display: flex; align-items: center; gap: 4px;
        }
        .fab-btn.active { background-color: var(--primary-work-dark); color: #fff; box-shadow: var(--shadow-sm); }
        .fab-btn.active-lock { background-color: #e0e0e0; color: #555; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š (ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆé¢¨) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { 
            background: #fff; padding: 24px 20px 40px 20px; 
            border-radius: 20px 20px 0 0; width: 100%; max-width: 600px; 
            max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s ease-out;
            box-sizing: border-box;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-textarea { width: 100%; height: 100px; padding: 12px; margin: 12px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; resize: vertical; font-family: inherit; }
        .modal-input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; background-color: #fafafa;}
        
        .modal-btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 6px;}
        .modal-btn.cancel { background-color: #f0f0f0; color: #666; }
        .modal-btn.save { background-color: var(--primary-work-dark); color: #fff; flex: 1;}
        .modal-btn.danger { background-color: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2;}

        /* è¨­å®šç”»é¢å†…ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .settings-section { margin-bottom: 20px; }
        .settings-section h4 { margin: 0 0 10px 0; font-size: 0.9rem; color: var(--primary-work-dark); display: flex; align-items: center; gap: 6px;}
        .settings-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px;}
        .settings-label { font-size: 0.85rem; font-weight: 700; color: var(--text-main); flex-shrink: 0; min-width: 80px;}

        #copyStatusMsg { background-color: rgba(46, 125, 50, 0.9); color: white; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; padding: 12px 24px; border-radius: 30px; display: none; box-shadow: var(--shadow-md); font-weight: 700; font-size: 0.9rem;}
    </style>
</head>
<body>
    <div class="app-container">
        
        <!-- æœˆåº¦ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <button class="nav-btn" id="prevBtn">â®</button>
            <div class="title-group">
                <div class="period-label-wrapper">
                    <div class="period-label" id="periodLabel"></div>
                    <div class="pattern-switch">
                        <button class="pattern-btn" id="patternA">A</button>
                        <button class="pattern-btn" id="patternB">B</button>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <h2 class="month-title" id="currentPeriodDisplay">èª­ã¿è¾¼ã¿ä¸­...</h2>
                    <div id="mainSyncStatus" class="sync-status-main">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</div>
                </div>
            </div>
            <button class="nav-btn" id="nextBtn">â¯</button>
        </div>

        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div class="toolbar locked" id="mainToolbar">
            <button class="tool-btn" id="noboriBtn">ğŸšš æ‹ ç‚¹ç©</button>
            <button class="tool-btn" id="memoModeBtn">ğŸ“ äºˆå®š</button>
            <button class="tool-btn" id="copyTextBtn">ğŸ“‹ å‡ºåŠ›</button>
            <button class="tool-btn" id="settingsBtn">âš™ï¸ è¨­å®š</button>
        </div>

        <!-- çµ±è¨ˆã‚¨ãƒªã‚¢ -->
        <div class="stats-bar locked" id="mainStatsBar">
            <div class="stat-item no-click" style="cursor: default;">
                <span class="stat-label-count">æ‰€å®š</span>
                <span class="stat-value" id="requiredDaysDisplay">-</span>
            </div>
            <div class="stat-item" id="modeWork" data-mode="work">
                <span class="stat-label-count">å‡ºå‹¤</span><span class="stat-value stat-work" id="workCount">0</span>
            </div>
            <div class="stat-item" id="modeWishLeave" data-mode="wish_leave">
                <span class="stat-label-count">å¸Œæœ›ä¼‘</span><span class="stat-value stat-wish">-</span>
            </div>
            <div class="stat-item" id="modeLeave" data-mode="leave">
                <span class="stat-label-count">æœ‰ä¼‘</span><span class="stat-value stat-leave" id="leaveCount">0</span>
            </div>
            <div class="stat-item" id="modeOff" data-mode="off">
                <span class="stat-label-count">ä¼‘æ—¥</span><span class="stat-value stat-off" id="offCount">0</span>
            </div>
            <div class="stat-item" id="modePublicOff" data-mode="public_off">
                <span class="stat-label-count">æ³•ä¼‘</span><span class="stat-value stat-public-off" id="publicOffCount">0</span>
            </div>
        </div>

        <!-- å…¨ä½“æ—¥æ•°ã¨æœ‰ä¼‘è¡¨ç¤º -->
        <div class="validation-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%;">
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <div class="total-days-display" id="totalDaysDisplay"></div>
                    <div id="leaveUsageDisplay" style="font-size: 0.75rem; font-weight: 700; color: var(--accent-leave-dark); display: none;"></div>
                </div>
            </div>
        </div>
        <div class="validation-messages" id="statusMessageContainer"></div>

        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="calendar-grid" id="calendarGrid"></div>
        
        <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ãƒ­ãƒƒã‚¯/ç·¨é›† ã‚¹ã‚¤ãƒƒãƒ -->
        <div class="floating-edit-switch" id="floatingEditSwitch">
            <button class="fab-btn active-lock" id="lockBtn">ğŸ”’ é–²è¦§</button>
            <button class="fab-btn" id="editBtn">âœï¸ ç·¨é›†</button>
        </div>
    </div>

    <!-- ã‚³ãƒ”ãƒ¼å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="copyStatusMsg"></div>

    <!-- ãƒ¡ãƒ¢ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="memoModal">
        <div class="modal-content" style="max-height: 50vh;">
            <div id="modalTitle" style="font-weight:700; margin-bottom:10px; font-size:1.1rem; color:var(--primary-work-dark)"></div>
            <textarea id="memoInput" class="modal-textarea" placeholder="äºˆå®šã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ› (ä¾‹: æ—©ç•ª, 13-22, ãƒªãƒ¼ãƒ€ãƒ¼ ãªã©)"></textarea>
            <div style="display:flex;justify-content:flex-end;gap:12px;">
                <button class="modal-btn cancel" id="memoCancelBtn">é–‰ã˜ã‚‹</button>
                <button class="modal-btn save" id="memoSaveBtn">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ) -->
    <div class="modal-overlay" id="settingsModal" style="align-items: flex-start; padding-top: 4vh; overflow-y: auto;">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h3 style="margin:0; font-size: 1.2rem;">è¨­å®š</h3>
                <button class="modal-btn cancel" style="padding: 6px 12px; margin:0;" id="settingsCloseIconBtn">âœ•</button>
            </div>
            
            <!-- åŒæœŸè¨­å®š -->
            <div class="settings-section">
                <h4>â˜ï¸ ãƒ‡ãƒ¼ã‚¿å…±æœ‰ãƒ»åŒæœŸ</h4>
                <p style="font-size:0.75rem; color:#666; margin-bottom:10px;">ä»–ã®ç«¯æœ«ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®IDã¨éµã§ã™ã€‚</p>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="shareIdInput" class="modal-input" placeholder="å…±æœ‰ID" style="flex: 1;">
                    <input type="password" id="passwordInput" class="modal-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="flex: 1;">
                </div>
                <div style="display:flex; gap:8px;">
                    <button id="registerBtn" class="modal-btn" style="flex:1; background-color:#e3f2fd; color:#1565c0; border: 1px solid #bbdefb;">æ–°è¦ç™»éŒ²</button>
                    <button id="connectBtn" class="modal-btn" style="flex:1; background-color:#e8f5e9; color:#2e7d32; border: 1px solid #c8e6c9;">èª­è¾¼ã™ã‚‹</button>
                </div>
                <div id="debugError" style="font-size: 10px; color: red; margin-top: 4px; display: none;"></div>
            </div>

            <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">
            
            <!-- ãƒ¡ãƒ¼ãƒ«è¨­å®š -->
            <div class="settings-section">
                <h4>âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«å‡ºåŠ›è¨­å®š</h4>
                <div style="margin-bottom: 12px;">
                    <label class="settings-label">å·®å‡ºäººå</label>
                    <input type="text" id="senderNameInput" class="modal-input" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" style="margin-top: 4px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label class="settings-label">é…è»Šä¿‚ã‚¢ãƒ‰ãƒ¬ã‚¹ 1</label>
                    <input type="email" id="email1Input" class="modal-input" placeholder="ä¾‹ï¼šhaisha1@example.com" style="margin-top: 4px;">
                </div>
                <div style="margin-bottom: 8px;">
                    <label class="settings-label">é…è»Šä¿‚ã‚¢ãƒ‰ãƒ¬ã‚¹ 2 (ä»»æ„)</label>
                    <input type="email" id="email2Input" class="modal-input" placeholder="ä¾‹ï¼šhaisha2@example.com" style="margin-top: 4px;">
                </div>
            </div>
            
            <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">
            
            <!-- æœ‰çµ¦ä¼‘æš‡ -->
            <div class="settings-section">
                <h4>ğŸ–ï¸ å¹´æ¬¡æœ‰çµ¦ä¼‘æš‡</h4>
                <div class="settings-row">
                    <label class="settings-label">ä»˜ä¸æ—¥æ•°</label>
                    <div style="display:flex; align-items:center; gap:4px;">
                        <input type="number" id="leaveDaysInput" class="modal-input" style="width: 80px; text-align:right;" placeholder="40"> <span>æ—¥</span>
                    </div>
                </div>
                <div class="settings-row">
                    <label class="settings-label">åŸºæº–æ—¥</label>
                    <div style="display:flex; align-items:center; gap:4px;">
                        <select id="leaveBaseMonthInput" class="modal-input" style="width: 70px;"></select> <span>æœˆ</span>
                        <select id="leaveBaseDayInput" class="modal-input" style="width: 70px;"></select> <span>æ—¥</span>
                    </div>
                </div>
            </div>

            <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">

            <!-- æ‰€å®šæ—¥æ•° -->
            <div class="settings-section">
                <h4>ğŸ“… æ‰€å®šæ—¥æ•°ã®ä¸€æ‹¬è¨­å®š</h4>
                <select id="yearSelect" class="modal-input" style="margin-bottom: 12px; font-weight:700;">
                    <option value="2025">2025å¹´åº¦ (25å¹´4æœˆåº¦ã€œ26å¹´3æœˆåº¦)</option>
                    <option value="2026">2026å¹´åº¦ (26å¹´4æœˆåº¦ã€œ27å¹´3æœˆåº¦)</option>
                    <option value="2027">2027å¹´åº¦ (27å¹´4æœˆåº¦ã€œ28å¹´3æœˆåº¦)</option>
                    <option value="2028">2028å¹´åº¦ (28å¹´4æœˆåº¦ã€œ29å¹´3æœˆåº¦)</option>
                    <option value="2029">2029å¹´åº¦ (29å¹´4æœˆåº¦ã€œ30å¹´3æœˆåº¦)</option>
                    <option value="2030">2030å¹´åº¦ (30å¹´4æœˆåº¦ã€œ31å¹´3æœˆåº¦)</option>
                </select>
                <div id="requiredDaysFormGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>

            <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">
            
            <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
            <div class="settings-section">
                <h4 style="color:#d32f2f;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                <div style="display:flex; gap:8px;">
                    <button class="modal-btn danger" id="resetAllBtn" style="flex:1; font-size:0.8rem; padding:10px;">è¡¨ç¤ºæœˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    <button class="modal-btn danger" id="allClearBtn" style="flex:1; font-size:0.8rem; padding:10px;">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
                </div>
            </div>

            <div style="display:flex; gap:12px; margin-top:30px;">
                <button class="modal-btn save" id="settingsSaveBtn">è¨­å®šã‚’ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- ç¢ºèªç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content" style="max-height: 40vh;">
            <h3 style="margin-top:0;">æœ€çµ‚ç¢ºèª</h3>
            <div id="confirmMessage" style="margin-bottom:20px; font-size:0.95rem; line-height:1.4;"></div>
            <div style="display:flex;justify-content:flex-end;gap:12px;">
                <button class="modal-btn cancel" id="confirmCancelBtn">ã‚„ã‚ã‚‹</button>
                <button class="modal-btn danger" id="confirmOkBtn" style="flex:1;">å®Ÿè¡Œã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal-content" style="max-height: 40vh;">
            <h3 id="alertTitle" style="margin-top:0; color:var(--status-error-text);">ãŠçŸ¥ã‚‰ã›</h3>
            <div id="alertMessage" style="margin-bottom:24px; font-size:0.95rem; white-space:pre-wrap; line-height:1.5;"></div>
            <div style="display:flex;">
                <button class="modal-btn save" onclick="document.getElementById('alertModal').classList.remove('active')" style="width:100%;">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDQ3fJpKeoQ6-mjsQGni8YlI8NH-Dp-JE0",
            authDomain: "ka-shift-calendar.firebaseapp.com",
            projectId: "ka-shift-calendar",
            storageBucket: "ka-shift-calendar.firebasestorage.app",
            messagingSenderId: "740196147233",
            appId: "1:740196147233:web:8e0c59b466f515fb2c8360",
            measurementId: "G-45CWYB75NE"
        };

        const appId = 'ka-shift-manager-v1';
        let db, auth, user, unsubscribeDoc = null, isCloudActive = false, saveTimeout = null, confirmCallback = null, currentMemoKey = null;
        let autoLockTimer = null;

        // localStorageã‹ã‚‰å®‰å…¨ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãŸã‚ã®é–¢æ•°
        function safeParse(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error("Local storage parsing error for " + key, e);
                return defaultValue;
            }
        }

        // A/Bãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¯¾å¿œã®Stateæ§‹é€ 
        const state = {
            currentStartDate: new Date(),
            currentPattern: localStorage.getItem('currentPattern') || 'A',
            
            password: localStorage.getItem('lastPassword') || '',

            attendance: safeParse('attendanceData', {}),
            markers: safeParse('markersData', {}), 
            attendance_B: safeParse('attendanceData_B', {}),
            markers_B: safeParse('markersData_B', {}), 
            
            requiredDays: safeParse('requiredDaysData', {}),
            notes: safeParse('notesData', {}),
            wishLeaves: safeParse('wishLeavesData', {}), 
            settings: safeParse('settingsData', { email1: '', email2: '', senderName: '', leaveDays: 0, leaveBaseMonth: 4, leaveBaseDay: 1 }), 
            
            selectedMode: null,
            isLocked: true 
        };

        // ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const getAtt = () => state.currentPattern === 'A' ? state.attendance : state.attendance_B;
        const getMar = () => state.currentPattern === 'A' ? state.markers : state.markers_B;

        function formatDateKey(d) { return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`; }
        function initDate() { const today = new Date(); if (today.getDate() <= 15) state.currentStartDate = new Date(today.getFullYear(), today.getMonth()-1, 16); else state.currentStartDate = new Date(today.getFullYear(), today.getMonth(), 16); }

        function showAlert(msg, title = 'ãŠçŸ¥ã‚‰ã›') {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = msg;
            document.getElementById('alertModal').classList.add('active');
        }

        function updateSyncStatus(text, statusClass) {
            const mainEl = document.getElementById('mainSyncStatus');
            if(mainEl) { 
                mainEl.textContent = text; 
                mainEl.className = `sync-status-main ${statusClass}`; 
            }
        }

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    const sid = localStorage.getItem('lastShareId');
                    const pwd = localStorage.getItem('lastPassword');
                    if (user && sid) { 
                        document.getElementById('shareIdInput').value = sid; 
                        if (pwd) {
                            document.getElementById('passwordInput').value = pwd;
                            state.password = pwd;
                        }
                        connect(sid); 
                    }
                });
            } catch (e) {
                showError("è¨­å®šã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        function showError(msg) {
            const el = document.getElementById('debugError');
            el.textContent = msg; el.style.display = 'block';
            updateSyncStatus("ã‚¨ãƒ©ãƒ¼", "error");
        }

        const safeAddEventListener = (id, event, handler) => {
            const el = document.getElementById(id);
            if (el) el.addEventListener(event, handler);
        };

        // è‡ªå‹•ãƒ­ãƒƒã‚¯é–¢æ•°
        function resetAutoLockTimer() {
            clearTimeout(autoLockTimer);
            if (!state.isLocked) {
                autoLockTimer = setTimeout(() => {
                    state.isLocked = true;
                    state.selectedMode = null;
                    render();
                }, 10 * 60 * 1000); 
            }
        }

        safeAddEventListener('registerBtn', 'click', async () => {
            const sid = document.getElementById('shareIdInput').value.trim();
            const pwd = document.getElementById('passwordInput').value.trim();
            if (!sid || !pwd) { showAlert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            if (!user || !db) return;

            document.getElementById('confirmMessage').textContent = `IDã€Œ${sid}ã€ã§æ–°ã—ãã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã®IDã‚’é–‹ãå ´åˆã¯ã€Œèª­è¾¼ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸€æ—¦éš ã—ã¦ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã™
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('confirmModal').classList.add('active');
            
            confirmCallback = async () => {
                if (unsubscribeDoc) unsubscribeDoc();
                updateSyncStatus("ç¢ºèªä¸­...", "active");

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        showAlert("ã“ã®IDã¯æ—¢ã«ä»–ã®äººã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\nåˆ¥ã®IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
                        updateSyncStatus("ã‚¨ãƒ©ãƒ¼", "error");
                        document.getElementById('settingsModal').classList.add('active'); 
                    } else {
                        isCloudActive = true; 
                        localStorage.setItem('lastShareId', sid);
                        localStorage.setItem('lastPassword', pwd);
                        state.password = pwd;
                        
                        state.attendance = {}; state.markers = {}; state.attendance_B = {}; state.markers_B = {};
                        state.requiredDays = {}; state.notes = {}; state.wishLeaves = {};
                        
                        const data = { 
                            password: pwd, attendance: state.attendance, markers: state.markers, attendance_B: state.attendance_B,
                            markers_B: state.markers_B, requiredDays: state.requiredDays, notes: state.notes, wishLeaves: state.wishLeaves,
                            settings: state.settings, updatedAt: new Date().toISOString() 
                        };
                        await setDoc(docRef, data);
                        showAlert(`IDã€Œ${sid}ã€ã§æ–°ã—ãç™»éŒ²ã—ã¾ã—ãŸï¼`);
                        connect(sid);
                    }
                } catch(e) {
                    showError("ã‚¨ãƒ©ãƒ¼: " + e.message);
                }
            };
        });

        safeAddEventListener('connectBtn', 'click', async () => {
            const sid = document.getElementById('shareIdInput').value.trim();
            const pwd = document.getElementById('passwordInput').value.trim();
            if (!sid || !pwd) { showAlert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            if (!user || !db) return;

            if (unsubscribeDoc) unsubscribeDoc();
            updateSyncStatus("ç¢ºèªä¸­...", "active");

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    showAlert("ç™»éŒ²ã•ã‚Œã¦ã„ãªã„IDã§ã™ã€‚\nIDã«é–“é•ã„ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    updateSyncStatus("ã‚¨ãƒ©ãƒ¼", "error");
                } else {
                    const data = docSnap.data();
                    const serverPwd = data.password || ""; 
                    
                    if (serverPwd !== pwd) {
                        showAlert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚");
                        updateSyncStatus("ã‚¨ãƒ©ãƒ¼", "error");
                        return;
                    }
                    
                    localStorage.setItem('lastPassword', pwd);
                    state.password = pwd;
                    connect(sid);
                    document.getElementById('settingsModal').classList.remove('active');
                }
            } catch(e) {
                showError("ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        });

        function connect(sid) {
            if (!user || !db || !sid) return;
            if (unsubscribeDoc) unsubscribeDoc();
            isCloudActive = true; localStorage.setItem('lastShareId', sid);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            updateSyncStatus("æ¥ç¶šä¸­...", "active");
            
            unsubscribeDoc = onSnapshot(docRef, (snap) => {
                if (snap.metadata.hasPendingWrites) return;
                if (snap.exists()) {
                    const data = snap.data();
                    const serverPwd = data.password || "";
                    
                    if (state.password !== serverPwd) {
                        isCloudActive = false;
                        if (unsubscribeDoc) unsubscribeDoc();
                        showAlert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\næ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€Œèª­è¾¼ã€ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
                        updateSyncStatus("èªè¨¼ã‚¨ãƒ©ãƒ¼", "error");
                        return;
                    }

                    state.attendance = data.attendance || {}; state.markers = data.markers || {};
                    state.attendance_B = data.attendance_B || {}; state.markers_B = data.markers_B || {};
                    state.requiredDays = data.requiredDays || {}; state.notes = data.notes || {}; 
                    state.wishLeaves = data.wishLeaves || {};
                    state.settings = data.settings || { email1: '', email2: '', senderName: '', leaveDays: 0, leaveBaseMonth: 4, leaveBaseDay: 1 };
                    render();
                    updateSyncStatus("ğŸŸ¢åŒæœŸä¸­", "saved");
                    document.getElementById('debugError').style.display = 'none';
                } else { 
                    isCloudActive = false;
                    updateSyncStatus("ãƒ‡ãƒ¼ã‚¿ãªã—", "error");
                }
            }, (err) => { 
                showError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.code); 
            });
        }

        function save(immediate = false) {
            localStorage.setItem('attendanceData', JSON.stringify(state.attendance));
            localStorage.setItem('markersData', JSON.stringify(state.markers));
            localStorage.setItem('attendanceData_B', JSON.stringify(state.attendance_B));
            localStorage.setItem('markersData_B', JSON.stringify(state.markers_B));
            localStorage.setItem('requiredDaysData', JSON.stringify(state.requiredDays));
            localStorage.setItem('notesData', JSON.stringify(state.notes));
            localStorage.setItem('wishLeavesData', JSON.stringify(state.wishLeaves));
            localStorage.setItem('settingsData', JSON.stringify(state.settings));
            localStorage.setItem('currentPattern', state.currentPattern);
            
            if (!isCloudActive || !user) return;
            const sid = document.getElementById('shareIdInput').value;
            if(!sid) return;
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            const data = { 
                password: state.password || '', 
                attendance: state.attendance, markers: state.markers, 
                attendance_B: state.attendance_B, markers_B: state.markers_B,
                requiredDays: state.requiredDays, notes: state.notes, 
                wishLeaves: state.wishLeaves, settings: state.settings,
                updatedAt: new Date().toISOString() 
            };
            if (saveTimeout) clearTimeout(saveTimeout);
            const doSave = () => { setDoc(docRef, data).catch(err => showError("ä¿å­˜ã‚¨ãƒ©ãƒ¼")); };
            if (immediate) doSave(); else saveTimeout = setTimeout(doSave, 800);
        }

        const Holidays = {
            getEquinox: (y, t) => Math.floor(((t==='v')?20.8431:23.2488) + 0.242194 * (y-1980) - Math.floor((y-1980)/4)),
            getMap: function(s, e) {
                const h = {}, d = new Date(s); d.setDate(d.getDate()-7); const end = new Date(e); end.setDate(end.getDate()+7);
                while(d <= end) { 
                    const y=d.getFullYear(), m=d.getMonth()+1, date=d.getDate(), w=d.getDay(), nth=Math.ceil(date/7);
                    let name = null;
                    if(m===1&&date===1)name="å…ƒæ—¥";else if(m===2&&date===11)name="å»ºå›½";else if(m===2&&date===23)name="å¤©çš‡";
                    else if(m===4&&date===29)name="æ˜­å’Œ";else if(m===5&&date===3)name="æ†²æ³•";else if(m===5&&date===4)name="ç·‘";
                    else if(m===5&&date===5)name="å­ä¾›";else if(m===8&&date===11)name="å±±";else if(m===11&&date===3)name="æ–‡åŒ–";else if(m===11&&date===23)name="å‹¤åŠ´";
                    else if(w===1){if(m===1&&nth===2)name="æˆäºº";if(m===7&&nth===3)name="æµ·";if(m===9&&nth===3)name="æ•¬è€";if(m===10&&nth===2)name="ã‚¹ãƒãƒ¼ãƒ„";}
                    if(m===3&&date===this.getEquinox(y,'v'))name="æ˜¥åˆ†";if(m===9&&date===this.getEquinox(y,'a'))name="ç§‹åˆ†";
                    if(name) h[formatDateKey(d)] = name; d.setDate(d.getDate()+1);
                }
                d.setTime(s.getTime()); d.setDate(d.getDate()-7);
                while(d <= end) { if(h[formatDateKey(d)] && d.getDay()===0) { let o=1; while(o<10){ const n=new Date(d); n.setDate(d.getDate()+o); if(h[formatDateKey(n)])o++; else{h[formatDateKey(n)]="æŒ¯æ›¿";break;} } } d.setDate(d.getDate()+1); }
                return h;
            }
        };

        function getMonthKey(year, monthDegree) {
            let targetYear = (monthDegree >= 4) ? parseInt(year) : parseInt(year) + 1;
            let startMonth = monthDegree - 1;
            if (startMonth === 0) { startMonth = 12; targetYear--; }
            return `${targetYear}-${('0' + startMonth).slice(-2)}-16`;
        }

        function calcLeaveUsage(currentEndDate) {
            const baseMonth = parseInt(state.settings.leaveBaseMonth) || 4;
            const baseDay = parseInt(state.settings.leaveBaseDay) || 1;
            const totalLeaveDays = parseInt(state.settings.leaveDays) || 0;
            if (totalLeaveDays === 0) return null;

            let year = currentEndDate.getFullYear();
            let baseDateThisYear = new Date(year, baseMonth - 1, baseDay);
            
            let startBaseDate, endBaseDate;
            if (currentEndDate >= baseDateThisYear) {
                startBaseDate = baseDateThisYear;
                endBaseDate = new Date(year + 1, baseMonth - 1, baseDay);
            } else {
                startBaseDate = new Date(year - 1, baseMonth - 1, baseDay);
                endBaseDate = baseDateThisYear;
            }

            let usedLeaves = 0;
            const att = getAtt();
            for (const [key, val] of Object.entries(att)) {
                if (val === 'leave') {
                    const [y, m, d] = key.split('-').map(Number);
                    const dateObj = new Date(y, m - 1, d);
                    if (dateObj >= startBaseDate && dateObj < endBaseDate) {
                        usedLeaves++;
                    }
                }
            }
            return { used: usedLeaves, total: totalLeaveDays };
        }

        function initMonthDataIfEmpty(start, end) {
            let hasData = false;
            let l = new Date(start);
            const att = getAtt();
            while(l <= end){
                if(att[formatDateKey(l)]) { hasData = true; break; }
                l.setDate(l.getDate()+1);
            }
            if(!hasData) {
                const h = Holidays.getMap(start, end);
                l = new Date(start);
                while(l <= end){
                    const k = formatDateKey(l);
                    const day = l.getDay();
                    if(day === 0 || day === 6 || h[k]) att[k] = 'off'; 
                    else att[k] = 'work';
                    l.setDate(l.getDate()+1);
                }
                save(); 
            }
        }

        function checkNoboriAlerts(start, end) {
            const alerts = [];
            let loop = new Date(start);
            const att = getAtt();
            const mar = getMar();
            while(loop <= end) {
                const k = formatDateKey(loop);
                const currentStatus = att[k];
                const hasMarker = mar[k];

                if (currentStatus === 'work' && !hasMarker) {
                    const next = new Date(loop);
                    next.setDate(loop.getDate() + 1);
                    const nextK = formatDateKey(next);
                    const nextStatus = att[nextK];
                    const nextMarker = mar[nextK];
                    
                    const isDepartureDay = (nextStatus === 'work' && !nextMarker);
                    if (!isDepartureDay) {
                        const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                        const prevStatus = att[formatDateKey(prev)];
                        if (prevStatus && prevStatus !== 'work') {
                            alerts.push({ msg: `${loop.getDate()}æ—¥ å‡ºå‹¤ï¼Ÿ` });
                        }
                    }
                }
                if (currentStatus === 'work' && !hasMarker) {
                     const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                     const prev2 = new Date(loop); prev2.setDate(loop.getDate() - 2);
                     const pk = formatDateKey(prev), pk2 = formatDateKey(prev2);
                     if (att[pk] === 'work' && !mar[pk] && att[pk2] === 'work' && !mar[pk2]) {
                         alerts.push({ msg: `${loop.getDate()}æ—¥ å‡ºå‹¤ï¼Ÿ(3é€£)` });
                     }
                }
                if (currentStatus !== 'work') {
                    const next = new Date(loop); next.setDate(loop.getDate() + 1);
                    if (!att[formatDateKey(next)] && checkIsLoading(loop)) {
                         alerts.push({ msg: `${loop.getDate()}æ—¥ ç¢ºèª` });
                    }
                }
                loop.setDate(loop.getDate()+1);
            }
            return alerts;
        }

        function checkIsLoading(currentDate) {
            const att = getAtt(); const mar = getMar();
            for (let i = 1; i <= 7; i++) {
                const prev = new Date(currentDate); prev.setDate(currentDate.getDate() - i);
                const prevK = formatDateKey(prev);
                if (att[prevK] === 'work' || att[prevK] === 'leave' || att[prevK] === 'off') {
                    if (mar[prevK]) return true; 
                    if (att[prevK] === 'work' && !mar[prevK]) return false; 
                }
            }
            return false;
        }

        function getWarningDates(start, end) {
            const warnings = new Set();
            let loop = new Date(start);
            const att = getAtt(); const mar = getMar();
            while(loop <= end) {
                const k = formatDateKey(loop);
                if (att[k] === 'work' && !mar[k]) {
                     const next = new Date(loop); next.setDate(loop.getDate() + 1);
                     if (!(att[formatDateKey(next)] === 'work' && !mar[formatDateKey(next)])) {
                         const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                         const prevK = formatDateKey(prev);
                         if (att[prevK] && att[prevK] !== 'work') warnings.add(prevK);
                     }
                }
                if (att[k] === 'work' && !mar[k]) {
                     const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                     const prev2 = new Date(loop); prev2.setDate(loop.getDate() - 2);
                     const pk = formatDateKey(prev), pk2 = formatDateKey(prev2);
                     if (att[pk] === 'work' && !mar[pk] && att[pk2] === 'work' && !mar[pk2]) warnings.add(k);
                }
                if (att[k] !== 'work') {
                    const next = new Date(loop); next.setDate(loop.getDate() + 1);
                    if (!att[formatDateKey(next)] && checkIsLoading(loop)) warnings.add(k);
                }
                loop.setDate(loop.getDate() + 1);
            }
            return warnings;
        }

        function render() {
            document.getElementById('patternA').classList.toggle('active', state.currentPattern === 'A');
            document.getElementById('patternB').classList.toggle('active', state.currentPattern === 'B');

            updateLockStateUI();
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const start = new Date(state.currentStartDate), end = new Date(start.getFullYear(), start.getMonth()+1, 15);
            
            initMonthDataIfEmpty(start, end);

            document.getElementById('periodLabel').textContent = `${end.getMonth()+1}æœˆåº¦`;
            document.getElementById('currentPeriodDisplay').textContent = `${start.getFullYear()}å¹´${start.getMonth()+1}æœˆ${start.getDate()}æ—¥ - ${end.getMonth()+1}æœˆ${end.getDate()}æ—¥`;
            
            const pk = formatDateKey(start); 
            const req = parseInt(state.requiredDays[pk]||0);
            document.getElementById('requiredDaysDisplay').textContent = req > 0 ? req : '-';

            const leaveStatus = calcLeaveUsage(end);
            const leaveDisplay = document.getElementById('leaveUsageDisplay');
            if (leaveStatus) {
                const remaining = leaveStatus.total - leaveStatus.used;
                leaveDisplay.textContent = `æœ‰çµ¦æ®‹æ•°: ${remaining}æ—¥ (æ¶ˆåŒ–: ${leaveStatus.used}/${leaveStatus.total}æ—¥)`;
                leaveDisplay.style.display = 'block';
            } else {
                leaveDisplay.style.display = 'none';
            }

            const holMap = Holidays.getMap(start, end);
            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => { const div=document.createElement('div'); div.className='weekday'; div.textContent=d; grid.appendChild(div); });
            
            const warningDates = getWarningDates(start, end);

            const startDay = start.getDay(); 
            for (let i = startDay; i > 0; i--) {
                const prevDate = new Date(start); prevDate.setDate(start.getDate() - i);
                createDayCell(prevDate, holMap, true, null, null, warningDates);
            }

            let loop = new Date(start), counts = { w:0, l:0, o:0, po:0, t:0 }, todayKey = formatDateKey(new Date());
            while (loop <= end) {
                createDayCell(loop, holMap, false, counts, todayKey, warningDates);
                loop.setDate(loop.getDate()+1);
            }

            const endDay = end.getDay();
            for (let i = 1; i < 7 - endDay; i++) {
                const nextDate = new Date(end); nextDate.setDate(end.getDate() + i);
                createDayCell(nextDate, holMap, true, null, null, warningDates);
            }

            document.getElementById('workCount').textContent=counts.w; 
            document.getElementById('leaveCount').textContent=counts.l; 
            document.getElementById('offCount').textContent=counts.o; 
            document.getElementById('publicOffCount').textContent=counts.po;
            
            const v = document.getElementById('statusMessageContainer'); v.innerHTML = ''; document.getElementById('totalDaysDisplay').textContent = `å…¨ä½“: ${counts.t}æ—¥`;
            const fill = counts.w+counts.l+counts.o+counts.po; 
            if (fill!==counts.t) { const d=document.createElement('div'); d.className='error-message'; d.textContent=`æœªå…¥åŠ›ãŒ ${counts.t-fill}æ—¥ ã‚ã‚Šã¾ã™ã€‚`; v.appendChild(d); }
            if(req>0){ 
                const act = counts.w + counts.l; 
                if(act<req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`ä¸è¶³: ${req-act}æ—¥`; v.appendChild(d); }
                else if(act>req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`è¶…é: ${act-req}æ—¥`; v.appendChild(d); } 
            }
            
            const alerts = checkNoboriAlerts(start, end);
            alerts.forEach(a => {
                const d = document.createElement('div'); 
                d.className='warn-message'; 
                d.textContent = `âš ï¸ ${a.msg}`; 
                v.appendChild(d);
            });

            document.querySelectorAll('.stat-item[data-mode]').forEach(el => el.classList.toggle('active-mode', el.dataset.mode===state.selectedMode));
            document.getElementById('noboriBtn').classList.toggle('active-tool', state.selectedMode==='nobori');
            document.getElementById('memoModeBtn').classList.toggle('active-tool', state.selectedMode==='memo');
        }

        function openMemoModal(dateKey) {
            currentMemoKey = dateKey;
            const existingNote = state.notes[dateKey] || "";
            document.getElementById('modalTitle').textContent = `${dateKey} ã®äºˆå®š`;
            document.getElementById('memoInput').value = existingNote;
            
            document.getElementById('memoModal').classList.add('active');
            document.getElementById('memoInput').focus();
        }

        function createDayCell(dateObj, holMap, isOutside, counts = null, todayKey = null, warningDates = new Set()) {
            const k = formatDateKey(dateObj);
            const att = getAtt();
            const mar = getMar();
            
            const s = att[k];
            const hol = holMap[k];
            const n = state.notes[k];
            const m = mar[k];
            const wl = state.wishLeaves[k];
            
            const cell = document.createElement('div'); 
            cell.className = 'day-cell';
            if (isOutside) cell.classList.add('outside-month');
            if (state.isLocked) cell.classList.add('locked'); 
            
            if (wl) cell.classList.add('is-wish-leave');

            const dWrap = document.createElement('div'); dWrap.style.display = "flex"; dWrap.style.alignItems = "center";
            const dNum = document.createElement('span'); 
            dNum.className = 'day-date'; 
            dNum.textContent = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`; 
            dWrap.appendChild(dNum);

            if (m) { const sp=document.createElement('span'); sp.className='nobori-mark'; sp.textContent='â—'; dWrap.appendChild(sp); }
            cell.appendChild(dWrap);
            
            if (hol) cell.classList.add('is-holiday'); 
            else if (dateObj.getDay()===0) cell.classList.add('is-sun'); 
            else if (dateObj.getDay()===6) cell.classList.add('is-sat');

            if (hol) { const hName = document.createElement('span'); hName.className = 'holiday-name'; hName.textContent = hol; cell.appendChild(hName); }
            if (s==='leave') { const l=document.createElement('span'); l.className='status-label'; l.textContent='æœ‰ä¼‘'; cell.appendChild(l); }
            
            if (n) { 
                const ns = document.createElement('span'); 
                ns.className = 'note-indicator'; 
                ns.textContent = 'ğŸ“'; 
                cell.appendChild(ns); 
            }
            
            if (k === todayKey) cell.classList.add('is-today');
            
            if (s==='work') { cell.classList.add('status-work'); if(counts) counts.w++; }
            else if (s==='leave') { cell.classList.add('status-leave'); if(counts) counts.l++; }
            else if (s==='off') { cell.classList.add('status-off'); if(counts) counts.o++; }
            else if (s==='public_off') { cell.classList.add('status-public-off'); if(counts) counts.po++; }
            
            if(counts) counts.t++;

            if (warningDates.has(k)) {
                const warnIcon = document.createElement('span');
                warnIcon.className = 'warning-icon';
                warnIcon.textContent = 'âš ï¸';
                cell.appendChild(warnIcon);
            }

            cell.onclick = () => { 
                if (state.isLocked) return;
                resetAutoLockTimer(); 
                if (!state.selectedMode) return; 

                if (state.selectedMode === 'memo') {
                    openMemoModal(k);
                } else if (state.selectedMode === 'wish_leave') {
                    if (state.wishLeaves[k]) delete state.wishLeaves[k];
                    else state.wishLeaves[k] = true;
                    save(); render();
                } else if (state.selectedMode === 'nobori') {
                    if (mar[k]) delete mar[k]; else mar[k] = true;
                    save(); render();
                } else if (!isOutside) {
                    if (state.selectedMode) {
                        if (att[k] === state.selectedMode) delete att[k];
                        else att[k] = state.selectedMode;
                    } else {
                        const cycle = [null, 'work', 'leave', 'off', 'public_off'];
                        const curIdx = cycle.indexOf(att[k] || null);
                        const nextStatus = cycle[(curIdx + 1) % cycle.length];
                        if (nextStatus) att[k] = nextStatus; else delete att[k];
                    }
                    save(); render();
                }
            };
            
            document.getElementById('calendarGrid').appendChild(cell);
        }

        function updateLockStateUI() {
            const lockBtn = document.getElementById('lockBtn');
            const editBtn = document.getElementById('editBtn');
            const toolbar = document.getElementById('mainToolbar');
            const statsBar = document.getElementById('mainStatsBar');

            if (state.isLocked) {
                if (lockBtn) lockBtn.classList.add('active-lock');
                if (editBtn) editBtn.classList.remove('active');
                if (toolbar) toolbar.classList.add('locked');
                if (statsBar) statsBar.classList.add('locked');
            } else {
                if (lockBtn) lockBtn.classList.remove('active-lock');
                if (editBtn) editBtn.classList.add('active');
                if (toolbar) toolbar.classList.remove('locked');
                if (statsBar) statsBar.classList.remove('locked');
            }
        }

        safeAddEventListener('lockBtn', 'click', () => { 
            state.isLocked = true; 
            state.selectedMode = null; 
            clearTimeout(autoLockTimer);
            render(); 
        });
        
        safeAddEventListener('editBtn', 'click', () => { 
            state.isLocked = false; 
            render(); 
            resetAutoLockTimer();
        });

        safeAddEventListener('patternA', 'click', () => { state.currentPattern = 'A'; localStorage.setItem('currentPattern', 'A'); render(); });
        safeAddEventListener('patternB', 'click', () => { state.currentPattern = 'B'; localStorage.setItem('currentPattern', 'B'); render(); });
        safeAddEventListener('prevBtn', 'click', () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()-1); render(); });
        safeAddEventListener('nextBtn', 'click', () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()+1); render(); });
        
        const monthSelect = document.getElementById('leaveBaseMonthInput');
        if (monthSelect) {
            for(let i=1; i<=12; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.textContent = i; monthSelect.appendChild(opt);
            }
        }
        
        const daySelect = document.getElementById('leaveBaseDayInput');
        if (daySelect) {
            for(let i=1; i<=31; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.textContent = i; daySelect.appendChild(opt);
            }
        }

        let tempRequiredDays = {};
        const yearSelect = document.getElementById('yearSelect');
        const reqDaysGrid = document.getElementById('requiredDaysFormGrid');

        function renderRequiredDaysForm() {
            if (!yearSelect || !reqDaysGrid) return;
            const y = yearSelect.value;
            reqDaysGrid.innerHTML = '';
            const months = [4,5,6,7,8,9,10,11,12,1,2,3];
            months.forEach(m => {
                const key = getMonthKey(y, m);
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.justifyContent = 'space-between';
                
                const label = document.createElement('span'); label.style.fontSize = '0.85rem'; label.textContent = `${m}æœˆåº¦:`;
                const input = document.createElement('input'); input.type = 'number'; input.className = 'modal-input';
                input.style.width = '60px'; input.style.margin = '0'; input.style.padding = '4px';
                input.value = tempRequiredDays[key] || '';
                input.oninput = (e) => { if (e.target.value) tempRequiredDays[key] = parseInt(e.target.value); else delete tempRequiredDays[key]; };
                
                div.appendChild(label); div.appendChild(input); reqDaysGrid.appendChild(div);
            });
        }
        if (yearSelect) yearSelect.onchange = renderRequiredDaysForm;

        safeAddEventListener('settingsBtn', 'click', () => {
            if (state.isLocked) return;
            resetAutoLockTimer();
            document.getElementById('senderNameInput').value = state.settings.senderName || '';
            document.getElementById('email1Input').value = state.settings.email1 || '';
            document.getElementById('email2Input').value = state.settings.email2 || '';
            
            document.getElementById('leaveDaysInput').value = state.settings.leaveDays || '';
            document.getElementById('leaveBaseMonthInput').value = state.settings.leaveBaseMonth || 4;
            document.getElementById('leaveBaseDayInput').value = state.settings.leaveBaseDay || 1;
            
            tempRequiredDays = { ...state.requiredDays };
            
            const currentEnd = new Date(state.currentStartDate.getFullYear(), state.currentStartDate.getMonth() + 1, 15);
            const m = currentEnd.getMonth() + 1;
            const y = currentEnd.getFullYear();
            const targetYear = (m >= 4) ? y : y - 1;
            
            if (yearSelect) {
                if (targetYear >= 2025 && targetYear <= 2030) yearSelect.value = targetYear;
                else yearSelect.value = 2025;
            }
            
            renderRequiredDaysForm();
            const modal = document.getElementById('settingsModal');
            if (modal) modal.classList.add('active');
        });

        const closeSettings = () => {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.classList.remove('active');
        };
        safeAddEventListener('settingsCancelBtn', 'click', closeSettings);
        safeAddEventListener('settingsCloseIconBtn', 'click', closeSettings);
        
        safeAddEventListener('settingsSaveBtn', 'click', () => {
            state.settings.senderName = document.getElementById('senderNameInput').value.trim();
            state.settings.email1 = document.getElementById('email1Input').value.trim();
            state.settings.email2 = document.getElementById('email2Input').value.trim();
            
            state.settings.leaveDays = parseInt(document.getElementById('leaveDaysInput').value) || 0;
            state.settings.leaveBaseMonth = parseInt(document.getElementById('leaveBaseMonthInput').value) || 4;
            state.settings.leaveBaseDay = parseInt(document.getElementById('leaveBaseDayInput').value) || 1;
            
            state.requiredDays = { ...tempRequiredDays };
            
            save(); render(); closeSettings();
        });

        // æœˆåº¦ãƒªã‚»ãƒƒãƒˆ (è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‹ã‚‰å‘¼ã°ã‚Œã‚‹)
        safeAddEventListener('resetAllBtn', 'click', () => {
            resetAutoLockTimer();
            const endMonth = state.currentStartDate.getMonth() + 2 > 12 ? (state.currentStartDate.getMonth() + 2) - 12 : state.currentStartDate.getMonth() + 2;
            const pLabel = state.currentPattern;
            
            const confirmMsg = document.getElementById('confirmMessage');
            if (confirmMsg) confirmMsg.textContent = `ã€Œ${endMonth}æœˆåº¦ (ãƒ‘ã‚¿ãƒ¼ãƒ³${pLabel})ã€ã‚’åˆæœŸçŠ¶æ…‹ï¼ˆå¹³æ—¥å‡ºå‹¤ãƒ»åœŸæ—¥ç¥ä¼‘ã¿ï¼‰ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆäºˆå®šã¯æ®‹ã‚Šã¾ã™ï¼‰`;
            
            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸€æ—¦éš ã™
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) settingsModal.classList.remove('active');
            
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) confirmModal.classList.add('active');
            
            confirmCallback = () => {
                const s = new Date(state.currentStartDate), e = new Date(s.getFullYear(), s.getMonth()+1, 15);
                const att = getAtt(); const mar = getMar();
                let l = new Date(s);
                while(l <= e){
                    const k = formatDateKey(l);
                    delete att[k]; delete mar[k]; delete state.wishLeaves[k]; 
                    l.setDate(l.getDate()+1);
                }
                save(true); render();
            };
        });

        // ã‚ªãƒ¼ãƒ«ã‚¯ãƒªã‚¢
        safeAddEventListener('allClearBtn', 'click', () => {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) settingsModal.classList.remove('active');
            
            const confirmMsg = document.getElementById('confirmMessage');
            if (confirmMsg) confirmMsg.textContent = `ã€è­¦å‘Šã€‘ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆA/Bä¸¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚·ãƒ•ãƒˆã€äºˆå®šã€å¸Œæœ›ä¼‘ãªã©ï¼‰ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\nâ€»è¨­å®šã¯æ®‹ã‚Šã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
            
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) confirmModal.classList.add('active');
            
            confirmCallback = () => {
                state.attendance = {}; state.markers = {}; state.attendance_B = {}; state.markers_B = {};
                state.notes = {}; state.wishLeaves = {}; state.requiredDays = {};
                save(true); render();
            };
        });
        
        safeAddEventListener('confirmOkBtn', 'click', () => { 
            if(confirmCallback) confirmCallback(); 
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) confirmModal.classList.remove('active'); 
        });
        
        safeAddEventListener('confirmCancelBtn', 'click', () => { 
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) confirmModal.classList.remove('active'); 
        });
        
        safeAddEventListener('noboriBtn', 'click', () => { state.selectedMode = state.selectedMode==='nobori'?null:'nobori'; render(); });
        safeAddEventListener('memoModeBtn', 'click', () => { state.selectedMode = state.selectedMode==='memo'?null:'memo'; render(); });
        
        safeAddEventListener('memoCancelBtn', 'click', () => {
            const memoModal = document.getElementById('memoModal');
            if (memoModal) memoModal.classList.remove('active');
        });
        
        safeAddEventListener('memoSaveBtn', 'click', () => { 
            const memoInput = document.getElementById('memoInput');
            if (memoInput) {
                const v = memoInput.value.trim(); 
                if(v) state.notes[currentMemoKey] = v; else delete state.notes[currentMemoKey]; 
                save(); render(); 
            }
            const memoModal = document.getElementById('memoModal');
            if (memoModal) memoModal.classList.remove('active'); 
        });
        
        // å‡ºåŠ›æ©Ÿèƒ½
        safeAddEventListener('copyTextBtn', 'click', (e) => { 
            e.preventDefault(); 
            if (state.isLocked) return;
            resetAutoLockTimer();

            const s = new Date(state.currentStartDate);
            const end = new Date(s.getFullYear(), s.getMonth()+1, 15);
            const weekChars = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            const holMap = Holidays.getMap(s, end);
            const att = getAtt();
            
            let datesList = '';
            let loop = new Date(s);
            
            while(loop <= end){ 
                const k = formatDateKey(loop); 
                // å¸Œæœ›ä¼‘(wishLeaves)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹æ—¥ ã¾ãŸã¯ æœ‰ä¼‘(ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®leave) ã‚’æŠ½å‡º
                if(state.wishLeaves[k] || att[k] === 'leave') { 
                    const day = loop.getDay();
                    const hol = holMap[k] ? ` ç¥æ—¥ï¼š${holMap[k]}` : '';
                    datesList += `ãƒ»${loop.getMonth()+1}/${loop.getDate()}(${weekChars[day]})${hol}\n`; 
                } 
                loop.setDate(loop.getDate()+1); 
            } 
            
            if(!datesList) {
                showAlert("å¸Œæœ›ä¼‘ã¾ãŸã¯æœ‰ä¼‘ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const email1 = state.settings.email1;
            const email2 = state.settings.email2;
            let toList = [];
            if (email1) toList.push(email1);
            if (email2) toList.push(email2);

            if (toList.length === 0) {
                showAlert("å®›å…ˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã€Œâš™ï¸ è¨­å®šã€ã‹ã‚‰é…è»Šä¿‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const senderName = state.settings.senderName ? `  ${state.settings.senderName}` : '';
            const subject = `å¸Œæœ›ä¼‘ç”³è«‹ ${end.getMonth()+1}æœˆåº¦${senderName}`;
            const body = `ãŠç–²ã‚Œæ§˜ã§ã™ã€‚\nä¸‹è¨˜ã«ã¦ã€ä¼‘ã¿ã‚’ã„ãŸã ããŸãç”³è«‹ã„ãŸã—ã¾ã™ã€‚\n\nã€${end.getMonth()+1}æœˆåº¦ ã€‘\n${datesList}\nãŠæ‰‹æ•°ã‚’ãŠã‹ã‘ã—ã¾ã™ãŒã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

            const dummy = document.createElement("textarea"); document.body.appendChild(dummy);
            dummy.value = body; dummy.select(); document.execCommand("copy"); document.body.removeChild(dummy);

            const mailtoUrl = `mailto:${toList.join(',')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            const ua = navigator.userAgent.toLowerCase();
            const isAppBrowser = ua.indexOf('line') > -1 || ua.indexOf('instagram') > -1;

            if (isAppBrowser) {
                const a = document.createElement('a'); a.href = mailtoUrl; a.target = '_blank'; a.rel = 'noopener noreferrer';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setTimeout(() => {
                    showAlert("ã€é‡è¦ã€‘\nLINEç­‰ã®ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªãŒæ­£å¸¸ã«èµ·å‹•ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\n\nå³ä¸‹ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãï¼ˆSafari/Chromeç­‰ï¼‰ã€ã‚’é¸æŠã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚\n\nâ€»ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã¾ã™ã€‚");
                }, 1500);
            } else {
                window.location.href = mailtoUrl;
            }

            const msg = document.getElementById('copyStatusMsg');
            if (msg) {
                msg.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™\nï¼ˆæœ¬æ–‡ã¯ã‚³ãƒ”ãƒ¼æ¸ˆã¿ã§ã™ï¼‰';
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
            }
        });

        ['Work','WishLeave','Leave','Off','PublicOff'].forEach(m => { 
            const id = 'mode' + m;
            const val = m.replace(/[A-Z]/g, l => '_' + l.toLowerCase()).replace(/^_/,''); 
            const el = document.getElementById(id);
            if (el) {
                el.onclick = () => { state.selectedMode = (state.selectedMode === val) ? null : val; render(); }; 
            }
        });

        ['mousedown', 'touchstart', 'keydown'].forEach(evt => document.addEventListener(evt, () => {
            if (typeof resetAutoLockTimer === 'function') resetAutoLockTimer();
        }));

        initDate(); render(); initFirebase(); 
    </script>
</body>
</html>