<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ v1.23 (æ‰€å®šæ—¥æ•°ç¶­æŒãƒªã‚»ãƒƒãƒˆç‰ˆ)</title>
    <style>
        /* --- Google Fonts (Noto Sans JP) --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --bg-color: #f4f1ea;
            --card-bg: #ffffff;
            --text-main: #4a4a4a;
            --text-sub: #8c8c8c;
            --primary-work: #a7d7c5;
            --primary-work-dark: #7fb5a1; 
            --accent-off: #ffb7b2;
            --accent-public-off: #ef9a9a;
            --accent-off-dark: #e08e89;
            --accent-leave: #ffb74d;
            --accent-leave-dark: #f57c00;
            --status-error-bg: #ffebee;
            --status-error-text: #c62828;
            --status-ok-bg: #e8f5e9;
            --status-ok-text: #2e7d32;
            --status-sync-bg: #e3f2fd;
            --status-sync-text: #1565c0;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh;
        }

        .app-container {
            width: 100%; max-width: 600px;
            background-color: var(--card-bg); border-radius: var(--radius);
            box-shadow: var(--shadow-card); overflow: hidden;
            display: flex; flex-direction: column; position: relative;
        }

        /* åŒæœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .cloud-section { padding: 12px 24px; background-color: #f8f9fa; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .cloud-header { font-size: 0.85rem; font-weight: 700; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center; }
        .cloud-controls { display: flex; gap: 8px; }
        .cloud-input { flex: 1; padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        .cloud-btn { padding: 6px 12px; background-color: var(--text-sub); color: white; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
        .cloud-btn.primary { background-color: var(--primary-work-dark); }
        
        .sync-status { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background-color: #eee; color: #666; display: inline-flex; align-items: center; gap: 4px; }
        .sync-status.active { background-color: var(--status-sync-bg); color: var(--status-sync-text); }
        .sync-status.saved { background-color: var(--status-ok-bg); color: var(--status-ok-text); }
        .sync-status.error { background-color: var(--status-error-bg); color: var(--status-error-text); }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar { display: flex; gap: 8px; padding: 8px 24px; background-color: #fff; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tool-btn { flex: 1; white-space: nowrap; padding: 8px 12px; border: 1px solid #eee; border-radius: 6px; background-color: #fff; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .tool-btn.active-tool { background-color: #fff3e0; border-color: #ffb74d; color: #f57c00; }
        .tool-btn.danger { color: #d32f2f; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { padding: 16px 24px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .period-label { font-size: 1rem; font-weight: 700; color: var(--primary-work-dark); margin-bottom: 4px; }
        .month-title { font-size: 1rem; font-weight: 500; color: var(--text-sub); margin: 0; }
        .nav-btn { background: none; border: none; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* çµ±è¨ˆã‚¨ãƒªã‚¢ */
        .stats-bar { display: flex; justify-content: space-between; align-items: flex-end; padding: 12px 10px; background-color: #fff; border-bottom: 1px solid #eee; gap: 4px; overflow-x: auto; }
        .stat-item { display: flex; flex-direction: column; align-items: center; padding: 6px 8px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; min-width: 40px; }
        .stat-item.active-mode { border-color: #ddd; background-color: #fafafa; }
        .stat-item[data-mode="work"].active-mode { border-color: var(--primary-work); background-color: #eaf7f2; }
        .stat-item[data-mode="leave"].active-mode { border-color: var(--accent-leave); background-color: #fff8e1; }
        .stat-item[data-mode="off"].active-mode { border-color: var(--accent-off); background-color: #ffebee; }
        .stat-item[data-mode="public_off"].active-mode { border-color: var(--accent-public-off); background-color: #ffebee; }
        .stat-label-count { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; white-space: nowrap; }
        .stat-value { font-size: 1.1rem; font-weight: 700; line-height: 1.2; }
        .input-field { width: 40px; text-align: center; border-radius: 6px; border: 1px solid #eee; font-weight: 700; }

        .validation-area { padding: 8px 24px; background-color: #fafafa; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 4px; }
        .error-message { color: var(--status-error-text); background-color: var(--status-error-bg); padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 16px; }
        .weekday { text-align: center; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 8px; }
        .day-cell { aspect-ratio: 1/1; border-radius: 8px; background-color: #f9f9f9; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 4px 2px; cursor: pointer; position: relative; font-weight: 500; overflow: hidden; }
        
        /* ç¥æ—¥ãƒ»æ—¥æ›œæ—¥ã®èµ¤è‰²ã‚’æœ€å„ªå…ˆã™ã‚‹è¨­å®š */
        .day-cell.is-sun, .day-cell.is-holiday { color: #d32f2f !important; }
        .day-cell.is-sat { color: #1565c0; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èƒŒæ™¯è‰²è¨­å®š */
        .day-cell.status-work { background-color: var(--primary-work); color: #fff; }
        .day-cell.status-leave { background-color: var(--accent-leave); color: #fff; }
        .day-cell.status-off { background-color: var(--accent-off); color: #fff; }
        .day-cell.status-public-off { background-color: var(--accent-public-off); color: #fff; }
        
        /* ç¥æ—¥ã®æ—¥ã®ãƒ†ã‚­ã‚¹ãƒˆã¯èƒŒæ™¯è‰²ãŒã‚ã£ã¦ã‚‚èµ¤è‰²ã‚’æ­»å®ˆ */
        .day-cell.is-holiday, .day-cell.is-sun { font-weight: 700; }
        .day-cell.is-today { border: 2px solid var(--text-sub); }

        .nobori-mark { margin-left: 2px; font-size: 0.8rem; color: #4a4a4a; font-weight: normal; }
        .day-cell[class*="status-"] .nobori-mark { color: #fff; }
        .day-cell.is-holiday .nobori-mark, .day-cell.is-sun .nobori-mark { color: #d32f2f; }

        .holiday-name { font-size: 0.5rem; line-height: 1; margin-top: 1px; text-align: center; color: #d32f2f; font-weight: 400; }
        .status-label { font-size: 0.7rem; font-weight: 700; margin-top: 1px; }
        .note-text { font-size: 0.55rem; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 95%; font-weight: 400; opacity: 0.9; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 80%; max-width: 320px; }
        .modal-input { width: 100%; padding: 8px; margin: 12px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; }
        .modal-btn.save { background: var(--primary-work); color: #fff; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="cloud-section">
            <div class="cloud-header"><span>â˜ï¸ ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­å®š</span><span id="syncStatus" class="sync-status">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span></div>
            <div class="cloud-controls"><input type="text" id="shareIdInput" class="cloud-input" placeholder="å…±æœ‰ID (ä¾‹: my-shop-01)"><button id="connectBtn" class="cloud-btn primary">åŒæœŸé–‹å§‹</button></div>
            <div id="debugError" style="font-size: 10px; color: red; margin-top: 4px; display: none;"></div>
        </div>
        <div class="toolbar">
            <button class="tool-btn" id="batchWorkBtn">âš¡ï¸ å¹³æ—¥ã‚’å‡ºå‹¤ã«ã™ã‚‹</button>
            <button class="tool-btn danger" id="resetAllBtn">â™»ï¸ è¡¨ç¤ºæœˆåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="tool-btn" id="noboriBtn">ğŸšš ã®ã¼ã‚Š</button>
        </div>
        <div class="header">
            <button class="nav-btn" id="prevBtn">â®</button>
            <div class="title-group"><div class="period-label" id="periodLabel"></div><h2 class="month-title" id="currentPeriodDisplay">èª­ã¿è¾¼ã¿ä¸­...</h2></div>
            <button class="nav-btn" id="nextBtn">â¯</button>
        </div>
        <div class="stats-bar">
            <div class="stat-item no-click"><label class="stat-label-count">æ‰€å®šæ—¥æ•°</label><input type="number" id="requiredDaysInput" class="input-field"></div>
            <div class="stat-item" id="modeWork" data-mode="work"><span class="stat-label-count">å‡ºå‹¤</span><span class="stat-value" id="workCount">0</span></div>
            <div class="stat-item" id="modeLeave" data-mode="leave"><span class="stat-label-count">æœ‰ä¼‘</span><span class="stat-value" id="leaveCount">0</span></div>
            <div class="stat-item" id="modeOff" data-mode="off"><span class="stat-label-count">ä¼‘æ—¥</span><span class="stat-value" id="offCount">0</span></div>
            <div class="stat-item" id="modePublicOff" data-mode="public_off"><span class="stat-label-count">å…¬ä¼‘</span><span class="stat-value" id="publicOffCount">0</span></div>
        </div>
        <div class="validation-area"><div id="totalDaysDisplay"></div><div id="statusMessageContainer"></div></div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="memoModal">
        <div class="modal-content"><div id="modalTitle"></div><input type="text" id="memoInput" class="modal-input"><div style="display:flex;justify-content:flex-end;gap:8px;"><button class="modal-btn" onclick="document.getElementById('memoModal').classList.remove('active')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn save" id="memoSaveBtn">ä¿å­˜</button></div></div>
    </div>
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content"><h3>ç¢ºèª</h3><div id="confirmMessage" style="margin-bottom:15px"></div><div style="display:flex;justify-content:flex-end;gap:8px;"><button class="modal-btn" onclick="document.getElementById('confirmModal').classList.remove('active')">ã‚„ã‚ã‚‹</button><button class="modal-btn" style="background:#d32f2f;color:#fff" id="confirmOkBtn">å®Ÿè¡Œ</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDQ3fJpKeoQ6-mjsQGni8YlI8NH-Dp-JE0",
            authDomain: "ka-shift-calendar.firebaseapp.com",
            projectId: "ka-shift-calendar",
            storageBucket: "ka-shift-calendar.firebasestorage.app",
            messagingSenderId: "740196147233",
            appId: "1:740196147233:web:8e0c59b466f515fb2c8360",
            measurementId: "G-45CWYB75NE"
        };

        const appId = 'ka-shift-manager-v1';
        let db, auth, user, unsubscribeDoc = null, isCloudActive = false, saveTimeout = null, confirmCallback = null, currentMemoKey = null;

        const state = {
            currentStartDate: new Date(),
            attendance: JSON.parse(localStorage.getItem('attendanceData')) || {},
            requiredDays: JSON.parse(localStorage.getItem('requiredDaysData')) || {},
            notes: JSON.parse(localStorage.getItem('notesData')) || {},
            markers: JSON.parse(localStorage.getItem('markersData')) || {}, 
            selectedMode: null,
        };

        function formatDateKey(d) { return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`; }
        function initDate() { const today = new Date(); if (today.getDate() <= 15) state.currentStartDate = new Date(today.getFullYear(), today.getMonth()-1, 16); else state.currentStartDate = new Date(today.getFullYear(), today.getMonth(), 16); }

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    const sid = localStorage.getItem('lastShareId');
                    if (user && sid) { document.getElementById('shareIdInput').value = sid; connect(sid); }
                });
            } catch (e) {
                showError("è¨­å®šã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        function showError(msg) {
            const el = document.getElementById('debugError');
            el.textContent = msg; el.style.display = 'block';
            document.getElementById('syncStatus').textContent = "ã‚¨ãƒ©ãƒ¼";
            document.getElementById('syncStatus').className = "sync-status error";
        }

        function connect(sid) {
            if (!user || !db || !sid) return;
            if (unsubscribeDoc) unsubscribeDoc();
            isCloudActive = true; localStorage.setItem('lastShareId', sid);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            document.getElementById('syncStatus').textContent = "æ¥ç¶šä¸­...";
            document.getElementById('syncStatus').className = "sync-status active";
            
            unsubscribeDoc = onSnapshot(docRef, (snap) => {
                if (snap.metadata.hasPendingWrites) return;
                if (snap.exists()) {
                    const data = snap.data();
                    state.attendance = data.attendance || {}; 
                    state.requiredDays = data.requiredDays || {};
                    state.notes = data.notes || {}; 
                    state.markers = data.markers || {};
                    render();
                    document.getElementById('syncStatus').className = 'sync-status saved';
                    document.getElementById('syncStatus').textContent = 'åŒæœŸä¸­';
                    document.getElementById('debugError').style.display = 'none';
                } else { save(true); }
            }, (err) => { showError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.code); });
        }

        function save(immediate = false) {
            localStorage.setItem('attendanceData', JSON.stringify(state.attendance));
            localStorage.setItem('requiredDaysData', JSON.stringify(state.requiredDays));
            localStorage.setItem('notesData', JSON.stringify(state.notes));
            localStorage.setItem('markersData', JSON.stringify(state.markers));
            if (!isCloudActive || !user) return;
            const sid = document.getElementById('shareIdInput').value;
            if(!sid) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            const data = { attendance: state.attendance, requiredDays: state.requiredDays, notes: state.notes, markers: state.markers, updatedAt: new Date().toISOString() };
            if (saveTimeout) clearTimeout(saveTimeout);
            const doSave = () => setDoc(docRef, data).catch(err => showError("ä¿å­˜ã‚¨ãƒ©ãƒ¼"));
            if (immediate) doSave(); else saveTimeout = setTimeout(doSave, 800);
        }

        const Holidays = {
            getEquinox: (y, t) => Math.floor(((t==='v')?20.8431:23.2488) + 0.242194 * (y-1980) - Math.floor((y-1980)/4)),
            getMap: function(s, e) {
                const h = {}, d = new Date(s); d.setDate(d.getDate()-7); const end = new Date(e); end.setDate(end.getDate()+7);
                while(d <= end) { 
                    const y=d.getFullYear(), m=d.getMonth()+1, date=d.getDate(), w=d.getDay(), nth=Math.ceil(date/7);
                    let name = null;
                    if(m===1&&date===1)name="å…ƒæ—¥";else if(m===2&&date===11)name="å»ºå›½";else if(m===2&&date===23)name="å¤©çš‡";
                    else if(m===4&&date===29)name="æ˜­å’Œ";else if(m===5&&date===3)name="æ†²æ³•";else if(m===5&&date===4)name="ç·‘";
                    else if(m===5&&date===5)name="å­ä¾›";else if(m===8&&date===11)name="å±±";else if(m===11&&date===3)name="æ–‡åŒ–";else if(m===11&&date===23)name="å‹¤åŠ´";
                    else if(w===1){if(m===1&&nth===2)name="æˆäºº";if(m===7&&nth===3)name="æµ·";if(m===9&&nth===3)name="æ•¬è€";if(m===10&&nth===2)name="ã‚¹ãƒãƒ¼ãƒ„";}
                    if(m===3&&date===this.getEquinox(y,'v'))name="æ˜¥åˆ†";if(m===9&&date===this.getEquinox(y,'a'))name="ç§‹åˆ†";
                    if(name) h[formatDateKey(d)] = name; d.setDate(d.getDate()+1);
                }
                d.setTime(s.getTime()); d.setDate(d.getDate()-7);
                while(d <= end) { if(h[formatDateKey(d)] && d.getDay()===0) { let o=1; while(o<10){ const n=new Date(d); n.setDate(d.getDate()+o); if(h[formatDateKey(n)])o++; else{h[formatDateKey(n)]="æŒ¯æ›¿";break;} } } d.setDate(d.getDate()+1); }
                return h;
            }
        };

        function render() {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const start = new Date(state.currentStartDate), end = new Date(start.getFullYear(), start.getMonth()+1, 15);
            document.getElementById('periodLabel').textContent = `${end.getMonth()+1}æœˆåº¦`;
            document.getElementById('currentPeriodDisplay').textContent = `${start.getFullYear()}å¹´${start.getMonth()+1}æœˆ${start.getDate()}æ—¥ - ${end.getMonth()+1}æœˆ${end.getDate()}æ—¥`;
            const pk = formatDateKey(start); document.getElementById('requiredDaysInput').value = state.requiredDays[pk] || '';
            const holMap = Holidays.getMap(start, end);
            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => { const div=document.createElement('div'); div.className='weekday'; div.textContent=d; grid.appendChild(div); });
            for (let i=0; i<start.getDay(); i++) { const e = document.createElement('div'); e.className = 'day-cell empty'; grid.appendChild(e); }
            let loop = new Date(start), counts = { w:0, l:0, o:0, po:0, t:0 }, todayKey = formatDateKey(new Date());
            while (loop <= end) {
                counts.t++; const k = formatDateKey(loop), s = state.attendance[k], hol = holMap[k], n = state.notes[k], m = state.markers[k];
                const cell = document.createElement('div'); cell.className = 'day-cell';
                const dWrap = document.createElement('div'); dWrap.style.display = "flex"; dWrap.style.alignItems = "center";
                const dNum = document.createElement('span'); dNum.textContent = loop.getDate();
                dWrap.appendChild(dNum);
                if (m) { const sp=document.createElement('span'); sp.className='nobori-mark'; sp.textContent='â—'; dWrap.appendChild(sp); }
                cell.appendChild(dWrap);
                if (hol) cell.classList.add('is-holiday'); else if (loop.getDay()===0) cell.classList.add('is-sun'); else if (loop.getDay()===6) cell.classList.add('is-sat');
                if (hol) { const hName = document.createElement('span'); hName.className = 'holiday-name'; hName.textContent = hol; cell.appendChild(hName); }
                if (s==='leave') { const l=document.createElement('span'); l.className='status-label'; l.textContent='æœ‰ä¼‘'; cell.appendChild(l); }
                if (n) { const ns=document.createElement('span'); ns.className='note-text'; ns.textContent=n; cell.appendChild(ns); }
                if (k === todayKey) cell.classList.add('is-today');
                if (s==='work') counts.w++, cell.classList.add('status-work');
                else if (s==='leave') counts.l++, cell.classList.add('status-leave');
                else if (s==='off') counts.o++, cell.classList.add('status-off');
                else if (s==='public_off') counts.po++, cell.classList.add('status-public-off');
                
                cell.onclick = () => { 
                    if (state.selectedMode === 'nobori') {
                        if (state.markers[k]) delete state.markers[k];
                        else state.markers[k] = true;
                    } else if (state.selectedMode) {
                        if (state.attendance[k] === state.selectedMode) delete state.attendance[k];
                        else state.attendance[k] = state.selectedMode;
                    } else {
                        const cycle = [null, 'work', 'leave', 'off', 'public_off'];
                        const curIdx = cycle.indexOf(state.attendance[k] || null);
                        const nextStatus = cycle[(curIdx + 1) % cycle.length];
                        if (nextStatus) state.attendance[k] = nextStatus;
                        else delete state.attendance[k];
                    }
                    save(); render(); 
                };
                cell.ondblclick = () => { currentMemoKey=k; document.getElementById('modalTitle').textContent=k+' ãƒ¡ãƒ¢'; document.getElementById('memoInput').value=state.notes[k]||''; document.getElementById('memoModal').classList.add('active'); };
                grid.appendChild(cell); loop.setDate(loop.getDate()+1);
            }
            document.getElementById('workCount').textContent=counts.w; document.getElementById('leaveCount').textContent=counts.l; document.getElementById('offCount').textContent=counts.o; document.getElementById('publicOffCount').textContent=counts.po;
            const v = document.getElementById('statusMessageContainer'); v.innerHTML = ''; document.getElementById('totalDaysDisplay').textContent = `å…¨ä½“: ${counts.t}æ—¥`;
            const fill = counts.w+counts.l+counts.o+counts.po; if (fill!==counts.t) { const d=document.createElement('div'); d.className='error-message'; d.textContent=`æœªå…¥åŠ›ãŒ ${counts.t-fill}æ—¥ ã‚ã‚Šã¾ã™ã€‚`; v.appendChild(d); }
            const req = parseInt(state.requiredDays[pk]||0); if(req>0){ const act=counts.w+counts.l; if(act<req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`ä¸è¶³: ${req-act}æ—¥`; v.appendChild(d); }else if(act>req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`è¶…é: ${act-req}æ—¥`; v.appendChild(d); } }
            document.querySelectorAll('.stat-item[data-mode]').forEach(el => el.classList.toggle('active-mode', el.dataset.mode===state.selectedMode));
            document.getElementById('noboriBtn').classList.toggle('active-tool', state.selectedMode==='nobori');
        }

        document.getElementById('prevBtn').onclick = () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()-1); render(); };
        document.getElementById('nextBtn').onclick = () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()+1); render(); };
        document.getElementById('connectBtn').onclick = () => { const id = document.getElementById('shareIdInput').value; if(id) connect(id); };
        document.getElementById('requiredDaysInput').oninput = (e) => { const k=formatDateKey(state.currentStartDate); if(e.target.value) state.requiredDays[k]=parseInt(e.target.value); else delete state.requiredDays[k]; save(); render(); };
        
        document.getElementById('batchWorkBtn').onclick = () => { 
            document.getElementById('confirmMessage').textContent = 'è¡¨ç¤ºä¸­ã®æœˆåº¦ã®å¹³æ—¥ã‚’ã™ã¹ã¦å‡ºå‹¤ã«ã—ã¾ã™ã‹ï¼Ÿ'; 
            document.getElementById('confirmModal').classList.add('active'); 
            confirmCallback = () => { 
                const s = new Date(state.currentStartDate), e = new Date(s.getFullYear(), s.getMonth()+1, 15), h = Holidays.getMap(s,e); 
                let l = new Date(s); while(l <= e){ const k = formatDateKey(l); if(l.getDay() !== 0 && l.getDay() !== 6 && !h[k]) state.attendance[k] = 'work'; l.setDate(l.getDate()+1); } 
                save(); render(); 
            }; 
        };

        // æœˆåº¦åˆ¥ãƒªã‚»ãƒƒãƒˆ (æ‰€å®šæ—¥æ•°ã¯æ¶ˆã•ãªã„)
        document.getElementById('resetAllBtn').onclick = () => {
            const endMonth = state.currentStartDate.getMonth() + 2 > 12 ? (state.currentStartDate.getMonth() + 2) - 12 : state.currentStartDate.getMonth() + 2;
            document.getElementById('confirmMessage').textContent = `ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã€Œ${endMonth}æœˆåº¦ã€ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆå‡ºå‹¤ã€ãƒ¡ãƒ¢ã€ã®ã¼ã‚Šï¼‰ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆâ€»æ‰€å®šæ—¥æ•°ã‚„ä»–ã®æœˆåº¦ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰`;
            document.getElementById('confirmModal').classList.add('active');
            confirmCallback = () => {
                const s = new Date(state.currentStartDate), e = new Date(s.getFullYear(), s.getMonth()+1, 15);
                let l = new Date(s);
                while(l <= e){
                    const k = formatDateKey(l);
                    delete state.attendance[k];
                    delete state.notes[k];
                    delete state.markers[k];
                    l.setDate(l.getDate()+1);
                }
                save(true);
                render();
            };
        };
        
        document.getElementById('confirmOkBtn').onclick = () => { if(confirmCallback) confirmCallback(); document.getElementById('confirmModal').classList.remove('active'); };
        document.getElementById('noboriBtn').onclick = () => { state.selectedMode = state.selectedMode==='nobori'?null:'nobori'; render(); };
        document.getElementById('memoSaveBtn').onclick = () => { const v = document.getElementById('memoInput').value.trim(); if(v) state.notes[currentMemoKey] = v; else delete state.notes[currentMemoKey]; save(); render(); document.getElementById('memoModal').classList.remove('active'); };
        ['Work','Leave','Off','PublicOff'].forEach(m => { const id = 'mode' + m, val = m.replace(/[A-Z]/g, l => '_' + l.toLowerCase()).replace(/^_/,''); document.getElementById(id).onclick = () => { state.selectedMode = (state.selectedMode === val) ? null : val; render(); }; });

        initDate(); render(); initFirebase(); 
    </script>
</body>
</html>