<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âã§ÂãôÁÆ°ÁêÜ„Ç´„É¨„É≥„ÉÄ„Éº v1.33 („É°„É¢Êã°Â§ßÁâà)</title>
    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --bg-color: #f4f1ea;
            --card-bg: #ffffff;
            --text-main: #4a4a4a;
            --text-sub: #8c8c8c;
            --primary-work: #a7d7c5;      /* Âá∫Âã§ */
            --primary-work-dark: #7fb5a1; 
            --accent-off: #ffb7b2;        /* ‰ºëÊó• */
            --accent-public-off: #ef9a9a; /* Ê≥ï‰ºë */
            --accent-off-dark: #e08e89;
            --accent-leave: #ffb74d;      /* Êúâ‰ºë */
            --accent-leave-dark: #f57c00;
            
            --status-error-bg: #ffebee;
            --status-error-text: #c62828;
            --status-warn-bg: #fff3e0;
            --status-warn-text: #e65100;
            --status-ok-bg: #e8f5e9;
            --status-ok-text: #2e7d32;
            --status-sync-bg: #e3f2fd;
            --status-sync-text: #1565c0;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh;
        }

        .app-container {
            width: 100%; max-width: 600px;
            background-color: var(--card-bg); border-radius: var(--radius);
            box-shadow: var(--shadow-card); overflow: hidden;
            display: flex; flex-direction: column; position: relative;
        }

        /* ÂêåÊúü„Çª„ÇØ„Ç∑„Éß„É≥ */
        .cloud-section { padding: 12px 24px; background-color: #f8f9fa; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .cloud-header { font-size: 0.85rem; font-weight: 700; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center; }
        .cloud-controls { display: flex; gap: 8px; }
        .cloud-input { flex: 1; padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        .cloud-btn { padding: 6px 12px; background-color: var(--text-sub); color: white; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
        .cloud-btn.primary { background-color: var(--primary-work-dark); }
        
        .sync-status { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background-color: #eee; color: #666; display: inline-flex; align-items: center; gap: 4px; }
        .sync-status.active { background-color: var(--status-sync-bg); color: var(--status-sync-text); }
        .sync-status.saved { background-color: var(--status-ok-bg); color: var(--status-ok-text); }
        .sync-status.error { background-color: var(--status-error-bg); color: var(--status-error-text); }

        /* „ÉÑ„Éº„É´„Éê„Éº */
        .toolbar { display: flex; gap: 8px; padding: 8px 24px; background-color: #fff; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tool-btn { flex: 1; white-space: nowrap; padding: 8px 12px; border: 1px solid #eee; border-radius: 6px; background-color: #fff; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
        .tool-btn:hover { background-color: #f9f9f9; }
        .tool-btn:active { background-color: #f0f0f0; }
        .tool-btn.active-tool { background-color: #fff3e0; border-color: #ffb74d; color: #f57c00; }
        .tool-btn.danger { color: #d32f2f; border-color: #ffcdd2; }
        .toolbar.locked .tool-btn { opacity: 0.5; pointer-events: none; }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header { padding: 16px 24px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .title-group { text-align: center; flex-grow: 1; }
        .period-label { font-size: 1.1rem; font-weight: 700; color: var(--primary-work-dark); margin-bottom: 4px; }
        .month-title { font-size: 0.9rem; font-weight: 500; color: var(--text-sub); margin: 0; }
        .nav-btn { background: none; border: none; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* Áµ±Ë®à„Ç®„É™„Ç¢ */
        .stats-bar { display: flex; justify-content: space-between; align-items: flex-end; padding: 12px 10px; background-color: #fff; border-bottom: 1px solid #eee; gap: 4px; overflow-x: auto; }
        .stat-item { display: flex; flex-direction: column; align-items: center; padding: 6px 8px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; min-width: 40px; background-color: #fff; transition: all 0.2s; }
        
        .stat-item[data-mode="work"] { border-color: var(--primary-work); }
        .stat-item[data-mode="leave"] { border-color: var(--accent-leave); }
        .stat-item[data-mode="off"] { border-color: var(--accent-off); }
        .stat-item[data-mode="public_off"] { border-color: var(--accent-public-off); }
        
        .stat-item[data-mode="work"].active-mode { background-color: #eaf7f2; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-item[data-mode="leave"].active-mode { background-color: #fff8e1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-item[data-mode="off"].active-mode { background-color: #ffebee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-item[data-mode="public_off"].active-mode { background-color: #ffebee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-color: #e57373; }

        .stat-item.no-click { cursor: default; border-color: #eee; }
        .stats-bar.locked .stat-item:not(.no-click) { opacity: 0.6; pointer-events: none; border-color: #eee; background-color: transparent; }

        .stat-label-count { font-size: 0.65rem; color: var(--text-main); font-weight: 700; white-space: nowrap; }
        .stat-value { font-size: 1.1rem; font-weight: 700; line-height: 1.2; }
        .stat-work { color: var(--primary-work-dark); }
        .stat-off { color: var(--accent-off-dark); }
        .stat-public-off { color: #e57373; }
        .stat-leave { color: var(--accent-leave-dark); }
        .input-field { width: 40px; text-align: center; border-radius: 6px; border: 1px solid #e0e0e0; font-weight: 700; }

        /* „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ & Á∑®ÈõÜ„É≠„ÉÉ„ÇØ„Ç®„É™„Ç¢ */
        .validation-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 24px; background-color: #fafafa; border-top: 1px solid #eee; }
        .total-days-display { font-weight: 700; color: var(--text-main); font-size: 0.85rem; }
        .edit-switch { display: flex; background-color: #e0e0e0; border-radius: 20px; padding: 2px; }
        .switch-btn { padding: 4px 12px; border-radius: 18px; border: none; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; color: #666; background: transparent; }
        .switch-btn.active { background-color: #fff; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .switch-btn.active.edit-mode { color: var(--primary-work-dark); }

        .validation-messages { padding: 0 24px 8px 24px; background-color: #fafafa; display: flex; flex-direction: column; gap: 4px; }
        .error-message { color: var(--status-error-text); background-color: var(--status-error-bg); padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; }
        .warn-message { color: var(--status-warn-text); background-color: var(--status-warn-bg); padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }

        /* „Ç´„É¨„É≥„ÉÄ„Éº */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 16px; }
        .weekday { text-align: center; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 8px; font-weight: 700; }
        .weekday:nth-child(1) { color: #d32f2f; }
        .weekday:nth-child(7) { color: #1565c0; }

        .day-cell { aspect-ratio: 1/1; border-radius: 8px; background-color: #f9f9f9; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 4px 2px; cursor: pointer; position: relative; font-weight: 500; overflow: hidden; transition: opacity 0.2s; }
        .day-cell.locked { cursor: default; }

        .day-cell.is-sun, .day-cell.is-holiday { color: #d32f2f !important; }
        .day-cell.is-sat { color: #1565c0; }
        .day-cell.outside-month { opacity: 0.4; background-color: #fff; }
        
        .day-cell.status-work { background-color: var(--primary-work); color: #fff; }
        .day-cell.status-leave { background-color: var(--accent-leave); color: #fff; }
        .day-cell.status-off { background-color: var(--accent-off); color: #fff; }
        .day-cell.status-public-off { background-color: var(--accent-public-off); color: #fff; }
        
        .day-cell.is-holiday, .day-cell.is-sun { font-weight: 700; }
        .day-cell.is-today { border: 2px solid var(--text-sub); }

        .nobori-mark { margin-left: 2px; font-size: 0.8rem; color: #4a4a4a; font-weight: normal; }
        .day-cell[class*="status-"] .nobori-mark { color: #fff; }
        .day-cell.is-holiday .nobori-mark, .day-cell.is-sun .nobori-mark { color: #d32f2f; }

        .holiday-name { font-size: 0.5rem; line-height: 1; margin-top: 1px; text-align: center; color: #d32f2f; font-weight: 400; }
        .status-label { font-size: 0.7rem; font-weight: 700; margin-top: 1px; }
        
        /* „É°„É¢Ë°®Á§∫„ÅÆË™øÊï¥ (ÊñáÂ≠ó„Çµ„Ç§„Ç∫Êã°Â§ß) */
        .note-text { 
            font-size: 0.9rem; /* ÂÖÉ„ÅÆ0.55rem„Åã„ÇâÊã°Â§ß */
            margin-top: 2px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 98%; 
            font-weight: 700; 
            opacity: 1; 
            color: #333;
            line-height: 1.1;
        }
        .day-cell[class*="status-"] .note-text { color: #fff; } /* ËÉåÊôØ„ÅÇ„Çä„Å™„ÇâÁôΩÊñáÂ≠ó */

        /* Ë≠¶Âëä„Ç¢„Ç§„Ç≥„É≥ */
        .warning-icon { 
            position: absolute; bottom: 2px; right: 2px; 
            font-size: 0.9rem; color: #ff9800; text-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.8; } }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 85%; max-width: 350px; }
        
        /* „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´Â§âÊõ¥ */
        .modal-textarea { 
            width: 100%; 
            height: 100px; 
            padding: 10px; 
            margin: 12px 0; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 1.1rem; /* ÂÖ•Âäõ„Åó„ÇÑ„Åô„ÅÑÂ§ß„Åç„Åï */
            resize: vertical;
            font-family: inherit;
        }
        
        .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; font-size: 0.9rem; }
        .modal-btn.cancel { background-color: #eee; color: #666; }
        .modal-btn.save { background: var(--primary-work); color: #fff; }
        .modal-btn.danger { background-color: #d32f2f; color: #fff; }

        #copyStatusMsg { background-color: var(--status-ok-bg); color: var(--status-ok-text); position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; padding: 10px 20px; border-radius: 20px; display: none; box-shadow: var(--shadow-card); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="cloud-section">
            <div class="cloud-header"><span>‚òÅÔ∏è „Éá„Éº„ÇøÂêåÊúüË®≠ÂÆö</span><span id="syncStatus" class="sync-status">„Ç™„Éï„É©„Ç§„É≥</span></div>
            <div class="cloud-controls"><input type="text" id="shareIdInput" class="cloud-input" placeholder="ÂÖ±ÊúâID (‰æãÔºöKato-taro„ÄÅ8068Á≠â)"><button id="connectBtn" class="cloud-btn primary">ÂêåÊúüÈñãÂßã</button></div>
            <div id="debugError" style="font-size: 10px; color: red; margin-top: 4px; display: none;"></div>
        </div>
        
        <div class="toolbar locked" id="mainToolbar">
            <button class="tool-btn" id="noboriBtn">üöö Êã†ÁÇπÁ©ç</button>
            <button class="tool-btn" id="copyTextBtn">üìã Êúâ‰ºëÁî≥Ë´ãÊó•</button>
            <button class="tool-btn danger" id="resetAllBtn">‚ôªÔ∏è „É™„Çª„ÉÉ„Éà</button>
        </div>

        <div class="header">
            <button class="nav-btn" id="prevBtn">‚ùÆ</button>
            <div class="title-group"><div class="period-label" id="periodLabel"></div><h2 class="month-title" id="currentPeriodDisplay">Ë™≠„ÅøËæº„Åø‰∏≠...</h2></div>
            <button class="nav-btn" id="nextBtn">‚ùØ</button>
        </div>

        <div class="stats-bar locked" id="mainStatsBar">
            <div class="stat-item no-click"><label class="stat-label-count">ÊâÄÂÆöÊó•Êï∞</label><input type="number" id="requiredDaysInput" class="input-field"></div>
            <div class="stat-item" id="modeWork" data-mode="work"><span class="stat-label-count">Âá∫Âã§</span><span class="stat-value stat-work" id="workCount">0</span></div>
            <div class="stat-item" id="modeLeave" data-mode="leave"><span class="stat-label-count">Êúâ‰ºë</span><span class="stat-value stat-leave" id="leaveCount">0</span></div>
            <div class="stat-item" id="modeOff" data-mode="off"><span class="stat-label-count">‰ºëÊó•</span><span class="stat-value stat-off" id="offCount">0</span></div>
            <div class="stat-item" id="modePublicOff" data-mode="public_off"><span class="stat-label-count">Ê≥ï‰ºë</span><span class="stat-value stat-public-off" id="publicOffCount">0</span></div>
        </div>

        <div class="validation-header">
            <div class="total-days-display" id="totalDaysDisplay"></div>
            <div class="edit-switch">
                <button class="switch-btn" id="lockBtn">„É≠„ÉÉ„ÇØ</button>
                <button class="switch-btn" id="editBtn">Á∑®ÈõÜ</button>
            </div>
        </div>
        <div class="validation-messages" id="statusMessageContainer"></div>

        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div id="copyStatusMsg">„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü</div>

    <!-- „É°„É¢Áî®„É¢„Éº„ÉÄ„É´ (Textarea„Å´Â§âÊõ¥) -->
    <div class="modal-overlay" id="memoModal">
        <div class="modal-content">
            <div id="modalTitle" style="font-weight:700; margin-bottom:10px;"></div>
            <textarea id="memoInput" class="modal-textarea" placeholder="„É°„É¢„ÇíÂÖ•Âäõ (‰æã: Êó©Áï™, 13-22, „É™„Éº„ÉÄ„Éº etc)"></textarea>
            <div style="display:flex;justify-content:flex-end;gap:8px;">
                <button class="modal-btn cancel" id="memoCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-btn save" id="memoSaveBtn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <h3>Á¢∫Ë™ç</h3>
            <div id="confirmMessage" style="margin-bottom:15px; font-size:0.9rem;"></div>
            <div style="display:flex;justify-content:flex-end;gap:8px;">
                <button class="modal-btn cancel" id="confirmCancelBtn">„ÇÑ„ÇÅ„Çã</button>
                <button class="modal-btn danger" id="confirmOkBtn">ÂÆüË°å</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDQ3fJpKeoQ6-mjsQGni8YlI8NH-Dp-JE0",
            authDomain: "ka-shift-calendar.firebaseapp.com",
            projectId: "ka-shift-calendar",
            storageBucket: "ka-shift-calendar.firebasestorage.app",
            messagingSenderId: "740196147233",
            appId: "1:740196147233:web:8e0c59b466f515fb2c8360",
            measurementId: "G-45CWYB75NE"
        };

        const appId = 'ka-shift-manager-v1';
        let db, auth, user, unsubscribeDoc = null, isCloudActive = false, saveTimeout = null, confirmCallback = null, currentMemoKey = null;
        let autoLockTimer = null;

        const state = {
            currentStartDate: new Date(),
            attendance: JSON.parse(localStorage.getItem('attendanceData')) || {},
            requiredDays: JSON.parse(localStorage.getItem('requiredDaysData')) || {},
            notes: JSON.parse(localStorage.getItem('notesData')) || {},
            markers: JSON.parse(localStorage.getItem('markersData')) || {}, 
            selectedMode: null,
            isLocked: true 
        };

        function formatDateKey(d) { return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`; }
        function initDate() { const today = new Date(); if (today.getDate() <= 15) state.currentStartDate = new Date(today.getFullYear(), today.getMonth()-1, 16); else state.currentStartDate = new Date(today.getFullYear(), today.getMonth(), 16); }

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    const sid = localStorage.getItem('lastShareId');
                    if (user && sid) { document.getElementById('shareIdInput').value = sid; connect(sid); }
                });
            } catch (e) {
                showError("Ë®≠ÂÆö„Ç®„É©„Éº: " + e.message);
            }
        }

        function showError(msg) {
            const el = document.getElementById('debugError');
            el.textContent = msg; el.style.display = 'block';
            document.getElementById('syncStatus').textContent = "„Ç®„É©„Éº";
            document.getElementById('syncStatus').className = "sync-status error";
        }

        function connect(sid) {
            if (!user || !db || !sid) return;
            if (unsubscribeDoc) unsubscribeDoc();
            isCloudActive = true; localStorage.setItem('lastShareId', sid);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            document.getElementById('syncStatus').textContent = "Êé•Á∂ö‰∏≠...";
            document.getElementById('syncStatus').className = "sync-status active";
            
            unsubscribeDoc = onSnapshot(docRef, (snap) => {
                if (snap.metadata.hasPendingWrites) return;
                if (snap.exists()) {
                    const data = snap.data();
                    state.attendance = data.attendance || {}; 
                    state.requiredDays = data.requiredDays || {};
                    state.notes = data.notes || {}; 
                    state.markers = data.markers || {};
                    render();
                    document.getElementById('syncStatus').className = 'sync-status saved';
                    document.getElementById('syncStatus').textContent = 'ÂêåÊúü‰∏≠';
                    document.getElementById('debugError').style.display = 'none';
                } else { 
                    save(true); 
                }
            }, (err) => { 
                showError("ÈÄö‰ø°„Ç®„É©„Éº: " + err.code); 
            });
        }

        function save(immediate = false) {
            localStorage.setItem('attendanceData', JSON.stringify(state.attendance));
            localStorage.setItem('requiredDaysData', JSON.stringify(state.requiredDays));
            localStorage.setItem('notesData', JSON.stringify(state.notes));
            localStorage.setItem('markersData', JSON.stringify(state.markers));
            if (!isCloudActive || !user) return;
            const sid = document.getElementById('shareIdInput').value;
            if(!sid) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            const data = { attendance: state.attendance, requiredDays: state.requiredDays, notes: state.notes, markers: state.markers, updatedAt: new Date().toISOString() };
            if (saveTimeout) clearTimeout(saveTimeout);
            const doSave = () => { setDoc(docRef, data).catch(err => showError("‰øùÂ≠ò„Ç®„É©„Éº")); };
            if (immediate) doSave(); else saveTimeout = setTimeout(doSave, 800);
        }

        function resetAutoLockTimer() {
            clearTimeout(autoLockTimer);
            if (!state.isLocked) {
                autoLockTimer = setTimeout(() => {
                    state.isLocked = true;
                    state.selectedMode = null;
                    render();
                }, 10 * 60 * 1000); 
            }
        }

        const Holidays = {
            getEquinox: (y, t) => Math.floor(((t==='v')?20.8431:23.2488) + 0.242194 * (y-1980) - Math.floor((y-1980)/4)),
            getMap: function(s, e) {
                const h = {}, d = new Date(s); d.setDate(d.getDate()-7); const end = new Date(e); end.setDate(end.getDate()+7);
                while(d <= end) { 
                    const y=d.getFullYear(), m=d.getMonth()+1, date=d.getDate(), w=d.getDay(), nth=Math.ceil(date/7);
                    let name = null;
                    if(m===1&&date===1)name="ÂÖÉÊó•";else if(m===2&&date===11)name="Âª∫ÂõΩ";else if(m===2&&date===23)name="Â§©Áöá";
                    else if(m===4&&date===29)name="Êò≠Âíå";else if(m===5&&date===3)name="ÊÜ≤Ê≥ï";else if(m===5&&date===4)name="Á∑ë";
                    else if(m===5&&date===5)name="Â≠ê‰æõ";else if(m===8&&date===11)name="Â±±";else if(m===11&&date===3)name="ÊñáÂåñ";else if(m===11&&date===23)name="Âã§Âä¥";
                    else if(w===1){if(m===1&&nth===2)name="Êàê‰∫∫";if(m===7&&nth===3)name="Êµ∑";if(m===9&&nth===3)name="Êï¨ËÄÅ";if(m===10&&nth===2)name="„Çπ„Éù„Éº„ÉÑ";}
                    if(m===3&&date===this.getEquinox(y,'v'))name="Êò•ÂàÜ";if(m===9&&date===this.getEquinox(y,'a'))name="ÁßãÂàÜ";
                    if(name) h[formatDateKey(d)] = name; d.setDate(d.getDate()+1);
                }
                d.setTime(s.getTime()); d.setDate(d.getDate()-7);
                while(d <= end) { if(h[formatDateKey(d)] && d.getDay()===0) { let o=1; while(o<10){ const n=new Date(d); n.setDate(d.getDate()+o); if(h[formatDateKey(n)])o++; else{h[formatDateKey(n)]="ÊåØÊõø";break;} } } d.setDate(d.getDate()+1); }
                return h;
            }
        };

        function initMonthDataIfEmpty(start, end) {
            let hasData = false;
            let l = new Date(start);
            while(l <= end){
                if(state.attendance[formatDateKey(l)]) { hasData = true; break; }
                l.setDate(l.getDate()+1);
            }
            if(!hasData) {
                const h = Holidays.getMap(start, end);
                l = new Date(start);
                while(l <= end){
                    const k = formatDateKey(l);
                    const day = l.getDay();
                    if(day === 0 || day === 6 || h[k]) state.attendance[k] = 'off'; 
                    else state.attendance[k] = 'work';
                    l.setDate(l.getDate()+1);
                }
                save(); 
            }
        }

        function checkNoboriAlerts(start, end) {
            const alerts = [];
            let loop = new Date(start);
            while(loop <= end) {
                const k = formatDateKey(loop);
                const currentStatus = state.attendance[k];
                const hasMarker = state.markers[k];

                if (currentStatus === 'work' && !hasMarker) {
                    const next = new Date(loop);
                    next.setDate(loop.getDate() + 1);
                    const nextK = formatDateKey(next);
                    const nextStatus = state.attendance[nextK];
                    const nextMarker = state.markers[nextK];
                    const isDepartureDay = (nextStatus === 'work' && !nextMarker);

                    if (!isDepartureDay) {
                        const prev = new Date(loop);
                        prev.setDate(loop.getDate() - 1);
                        const prevK = formatDateKey(prev);
                        const prevStatus = state.attendance[prevK];
                        if (prevStatus && prevStatus !== 'work') {
                            alerts.push({ msg: `${loop.getDate()}Êó• Âá∫Âã§Ôºü` });
                        }
                    }
                }
                
                if (currentStatus === 'work' && !hasMarker) {
                     const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                     const prev2 = new Date(loop); prev2.setDate(loop.getDate() - 2);
                     const pk = formatDateKey(prev);
                     const pk2 = formatDateKey(prev2);
                     if (state.attendance[pk] === 'work' && !state.markers[pk] &&
                         state.attendance[pk2] === 'work' && !state.markers[pk2]) {
                         alerts.push({ msg: `${loop.getDate()}Êó• Âá∫Âã§Ôºü(3ÈÄ£)` });
                     }
                }

                if (currentStatus !== 'work') {
                    const next = new Date(loop);
                    next.setDate(loop.getDate() + 1);
                    const nextK = formatDateKey(next);
                    const nextStatus = state.attendance[nextK];
                    if (!nextStatus && checkIsLoading(loop)) {
                         alerts.push({ msg: `${loop.getDate()}Êó• Á¢∫Ë™ç` });
                    }
                }
                loop.setDate(loop.getDate()+1);
            }
            return alerts;
        }

        function checkIsLoading(currentDate) {
            for (let i = 1; i <= 7; i++) {
                const prev = new Date(currentDate);
                prev.setDate(currentDate.getDate() - i);
                const prevK = formatDateKey(prev);
                const status = state.attendance[prevK];
                if (status === 'work' || status === 'leave' || status === 'off') {
                    if (state.markers[prevK]) return true; 
                    if (status === 'work' && !state.markers[prevK]) return false; 
                }
            }
            return false;
        }

        function getWarningDates(start, end) {
            const warnings = new Set();
            let loop = new Date(start);
            while(loop <= end) {
                const k = formatDateKey(loop);
                const status = state.attendance[k];
                const marker = state.markers[k];

                if (status === 'work' && !marker) {
                     const next = new Date(loop);
                     next.setDate(loop.getDate() + 1);
                     const nextK = formatDateKey(next);
                     const nextStatus = state.attendance[nextK];
                     const nextMarker = state.markers[nextK];
                     
                     const isDepartureDay = (nextStatus === 'work' && !nextMarker);

                     if (!isDepartureDay) {
                         const prev = new Date(loop);
                         prev.setDate(loop.getDate() - 1);
                         const prevK = formatDateKey(prev);
                         const prevStatus = state.attendance[prevK];
                         
                         if (prevStatus && prevStatus !== 'work') {
                             warnings.add(prevK);
                         }
                     }
                }

                if (status === 'work' && !marker) {
                     const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                     const prev2 = new Date(loop); prev2.setDate(loop.getDate() - 2);
                     const pk = formatDateKey(prev);
                     const pk2 = formatDateKey(prev2);
                     
                     if (state.attendance[pk] === 'work' && !state.markers[pk] &&
                         state.attendance[pk2] === 'work' && !state.markers[pk2]) {
                         warnings.add(k);
                     }
                }

                if (status !== 'work') {
                    const next = new Date(loop);
                    next.setDate(loop.getDate() + 1);
                    const nextK = formatDateKey(next);
                    const nextStatus = state.attendance[nextK];
                    
                    if (!nextStatus && checkIsLoading(loop)) {
                         warnings.add(k);
                    }
                }

                loop.setDate(loop.getDate() + 1);
            }
            return warnings;
        }

        function render() {
            updateLockStateUI();
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const start = new Date(state.currentStartDate), end = new Date(start.getFullYear(), start.getMonth()+1, 15);
            initMonthDataIfEmpty(start, end);

            document.getElementById('periodLabel').textContent = `${end.getMonth()+1}ÊúàÂ∫¶`;
            document.getElementById('currentPeriodDisplay').textContent = `${start.getFullYear()}Âπ¥${start.getMonth()+1}Êúà${start.getDate()}Êó• - ${end.getMonth()+1}Êúà${end.getDate()}Êó•`;
            const pk = formatDateKey(start); document.getElementById('requiredDaysInput').value = state.requiredDays[pk] || '';
            const holMap = Holidays.getMap(start, end);
            
            ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'].forEach(d => { const div=document.createElement('div'); div.className='weekday'; div.textContent=d; grid.appendChild(div); });
            
            const warningDates = getWarningDates(start, end);

            const startDay = start.getDay(); 
            for (let i = startDay; i > 0; i--) {
                const prevDate = new Date(start); prevDate.setDate(start.getDate() - i);
                createDayCell(prevDate, holMap, true, null, null, warningDates);
            }

            let loop = new Date(start), counts = { w:0, l:0, o:0, po:0, t:0 }, todayKey = formatDateKey(new Date());
            while (loop <= end) {
                createDayCell(loop, holMap, false, counts, todayKey, warningDates);
                loop.setDate(loop.getDate()+1);
            }

            const endDay = end.getDay();
            for (let i = 1; i < 7 - endDay; i++) {
                const nextDate = new Date(end); nextDate.setDate(end.getDate() + i);
                createDayCell(nextDate, holMap, true, null, null, warningDates);
            }

            document.getElementById('workCount').textContent=counts.w; 
            document.getElementById('leaveCount').textContent=counts.l; 
            document.getElementById('offCount').textContent=counts.o; 
            document.getElementById('publicOffCount').textContent=counts.po;
            
            const v = document.getElementById('statusMessageContainer'); v.innerHTML = ''; document.getElementById('totalDaysDisplay').textContent = `ÂÖ®‰Ωì: ${counts.t}Êó•`;
            const fill = counts.w+counts.l+counts.o+counts.po; 
            if (fill!==counts.t) { const d=document.createElement('div'); d.className='error-message'; d.textContent=`Êú™ÂÖ•Âäõ„Åå ${counts.t-fill}Êó• „ÅÇ„Çä„Åæ„Åô„ÄÇ`; v.appendChild(d); }
            const req = parseInt(state.requiredDays[pk]||0); 
            if(req>0){ const act=counts.w+counts.l; if(act<req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`‰∏çË∂≥: ${req-act}Êó•`; v.appendChild(d); }else if(act>req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`Ë∂ÖÈÅé: ${act-req}Êó•`; v.appendChild(d); } }
            
            const alerts = checkNoboriAlerts(start, end);
            alerts.forEach(a => {
                const d = document.createElement('div'); 
                d.className='warn-message'; 
                d.textContent = `‚ö†Ô∏è ${a.msg}`; 
                v.appendChild(d);
            });

            document.querySelectorAll('.stat-item[data-mode]').forEach(el => el.classList.toggle('active-mode', el.dataset.mode===state.selectedMode));
            document.getElementById('noboriBtn').classList.toggle('active-tool', state.selectedMode==='nobori');
        }

        function createDayCell(dateObj, holMap, isOutside, counts = null, todayKey = null, warningDates = new Set()) {
            const k = formatDateKey(dateObj);
            const s = state.attendance[k];
            const hol = holMap[k];
            const n = state.notes[k];
            const m = state.markers[k];
            
            const cell = document.createElement('div'); 
            cell.className = 'day-cell';
            if (isOutside) cell.classList.add('outside-month');
            if (state.isLocked) cell.classList.add('locked'); 

            const dWrap = document.createElement('div'); dWrap.style.display = "flex"; dWrap.style.alignItems = "center";
            const dNum = document.createElement('span'); dNum.textContent = dateObj.getDate();
            dWrap.appendChild(dNum);
            if (m) { const sp=document.createElement('span'); sp.className='nobori-mark'; sp.textContent='‚óè'; dWrap.appendChild(sp); }
            cell.appendChild(dWrap);
            
            if (hol) cell.classList.add('is-holiday'); 
            else if (dateObj.getDay()===0) cell.classList.add('is-sun'); 
            else if (dateObj.getDay()===6) cell.classList.add('is-sat');

            if (hol) { const hName = document.createElement('span'); hName.className = 'holiday-name'; hName.textContent = hol; cell.appendChild(hName); }
            if (s==='leave') { const l=document.createElement('span'); l.className='status-label'; l.textContent='Êúâ‰ºë'; cell.appendChild(l); }
            if (n) { const ns=document.createElement('span'); ns.className='note-text'; ns.textContent=n; cell.appendChild(ns); }
            
            if (k === todayKey) cell.classList.add('is-today');
            
            if (s==='work') { cell.classList.add('status-work'); if(counts) counts.w++; }
            else if (s==='leave') { cell.classList.add('status-leave'); if(counts) counts.l++; }
            else if (s==='off') { cell.classList.add('status-off'); if(counts) counts.o++; }
            else if (s==='public_off') { cell.classList.add('status-public-off'); if(counts) counts.po++; }
            
            if(counts) counts.t++;

            if (warningDates.has(k)) {
                const warnIcon = document.createElement('span');
                warnIcon.className = 'warning-icon';
                warnIcon.textContent = '‚ö†Ô∏è';
                cell.appendChild(warnIcon);
            }

            cell.onclick = () => { 
                if (state.isLocked) return;
                resetAutoLockTimer(); 

                if (state.selectedMode === 'nobori') {
                    if (state.markers[k]) delete state.markers[k]; else state.markers[k] = true;
                    save(); render();
                } else if (!isOutside) {
                    if (state.selectedMode) {
                        if (state.attendance[k] === state.selectedMode) delete state.attendance[k];
                        else state.attendance[k] = state.selectedMode;
                    } else {
                        const cycle = [null, 'work', 'leave', 'off', 'public_off'];
                        const curIdx = cycle.indexOf(state.attendance[k] || null);
                        const nextStatus = cycle[(curIdx + 1) % cycle.length];
                        if (nextStatus) state.attendance[k] = nextStatus; else delete state.attendance[k];
                    }
                    save(); render();
                }
            };
            
            if (!isOutside) {
                cell.ondblclick = () => { 
                    if (state.isLocked) return;
                    resetAutoLockTimer(); 
                    currentMemoKey=k; document.getElementById('modalTitle').textContent=k+' „É°„É¢'; document.getElementById('memoInput').value=state.notes[k]||''; document.getElementById('memoModal').classList.add('active'); 
                };
            }
            document.getElementById('calendarGrid').appendChild(cell);
        }

        function updateLockStateUI() {
            const lockBtn = document.getElementById('lockBtn');
            const editBtn = document.getElementById('editBtn');
            const toolbar = document.getElementById('mainToolbar');
            const statsBar = document.getElementById('mainStatsBar');
            const requiredInput = document.getElementById('requiredDaysInput');

            if (state.isLocked) {
                lockBtn.classList.add('active');
                editBtn.classList.remove('active', 'edit-mode');
                toolbar.classList.add('locked');
                statsBar.classList.add('locked');
                requiredInput.disabled = true;
            } else {
                lockBtn.classList.remove('active');
                editBtn.classList.add('active', 'edit-mode');
                toolbar.classList.remove('locked');
                statsBar.classList.remove('locked');
                requiredInput.disabled = false;
            }
        }

        document.getElementById('lockBtn').onclick = () => { 
            state.isLocked = true; 
            state.selectedMode = null; 
            clearTimeout(autoLockTimer);
            render(); 
        };
        document.getElementById('editBtn').onclick = () => { 
            state.isLocked = false; 
            render(); 
            resetAutoLockTimer();
        };

        document.getElementById('prevBtn').onclick = () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()-1); render(); };
        document.getElementById('nextBtn').onclick = () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()+1); render(); };
        document.getElementById('connectBtn').onclick = () => { const id = document.getElementById('shareIdInput').value; if(id) connect(id); };
        document.getElementById('requiredDaysInput').oninput = (e) => { const k=formatDateKey(state.currentStartDate); if(e.target.value) state.requiredDays[k]=parseInt(e.target.value); else delete state.requiredDays[k]; save(); render(); };
        
        document.getElementById('resetAllBtn').onclick = () => {
            if(state.isLocked) return; 
            resetAutoLockTimer();
            const endMonth = state.currentStartDate.getMonth() + 2 > 12 ? (state.currentStartDate.getMonth() + 2) - 12 : state.currentStartDate.getMonth() + 2;
            document.getElementById('confirmMessage').textContent = `„Äå${endMonth}ÊúàÂ∫¶„Äç„ÇíÂàùÊúüÁä∂ÊÖãÔºàÂπ≥Êó•Âá∫Âã§„ÉªÂúüÊó•Á•ù‰ºë„ÅøÔºâ„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºàÁèæÂú®„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„Åå„ÄÅ„É°„É¢„ÅØÊÆã„Çä„Åæ„ÅôÔºâ`;
            document.getElementById('confirmModal').classList.add('active');
            confirmCallback = () => {
                const s = new Date(state.currentStartDate), e = new Date(s.getFullYear(), s.getMonth()+1, 15);
                let l = new Date(s);
                while(l <= e){
                    const k = formatDateKey(l);
                    delete state.attendance[k];
                    // delete state.notes[k]; 
                    delete state.markers[k];
                    l.setDate(l.getDate()+1);
                }
                save(true);
                render();
            };
        };
        
        document.getElementById('confirmOkBtn').onclick = () => { if(confirmCallback) confirmCallback(); document.getElementById('confirmModal').classList.remove('active'); };
        document.getElementById('confirmCancelBtn').onclick = () => { document.getElementById('confirmModal').classList.remove('active'); };
        document.getElementById('noboriBtn').onclick = () => { state.selectedMode = state.selectedMode==='nobori'?null:'nobori'; render(); };
        document.getElementById('memoCancelBtn').onclick = () => document.getElementById('memoModal').classList.remove('active');
        document.getElementById('memoSaveBtn').onclick = () => { const v = document.getElementById('memoInput').value.trim(); if(v) state.notes[currentMemoKey] = v; else delete state.notes[currentMemoKey]; save(); render(); document.getElementById('memoModal').classList.remove('active'); };
        
        // „Ç≥„Éî„ÉºÊ©üËÉΩ
        document.getElementById('copyTextBtn').onclick = () => { 
            const s=new Date(state.currentStartDate), e=new Date(s.getFullYear(), s.getMonth()+1, 15), w=['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü']; 
            let t=`„Äê${e.getMonth()+1}ÊúàÂ∫¶ Êúâ‰ºë„Äë\n`, c=0, l=new Date(s); 
            while(l<=e){ 
                const k=formatDateKey(l); 
                if(state.attendance[k]==='leave'){ 
                    c++; t+=`${l.getDate()}(${w[l.getDay()]}): Êúâ‰ºë${state.notes[k]?' ('+state.notes[k]+')':''}\n`; 
                } 
                l.setDate(l.getDate()+1); 
            } 
            t+=(c===0)?"„Å™„Åó":`ÂêàË®à: ${c}Êó•`; 
            const dummy = document.createElement("textarea"); document.body.appendChild(dummy);
            dummy.value = t; dummy.select(); document.execCommand("copy"); document.body.removeChild(dummy);
            const msg = document.getElementById('copyStatusMsg'); msg.style.display = 'block'; setTimeout(() => { msg.style.display = 'none'; }, 2000);
        };

        ['Work','Leave','Off','PublicOff'].forEach(m => { const id = 'mode' + m, val = m.replace(/[A-Z]/g, l => '_' + l.toLowerCase()).replace(/^_/,''); document.getElementById(id).onclick = () => { state.selectedMode = (state.selectedMode === val) ? null : val; render(); }; });

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÁôªÈå≤ (Ëá™Âãï„É≠„ÉÉ„ÇØ„É™„Çª„ÉÉ„ÉàÁî®)
        ['mousedown', 'touchstart', 'keydown'].forEach(evt => 
            document.addEventListener(evt, resetAutoLockTimer)
        );

        initDate(); render(); initFirebase(); 
    </script>
</body>
</html>