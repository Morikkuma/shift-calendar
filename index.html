<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ v1.53 (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»èª¤æ“ä½œé˜²æ­¢å¼·åŒ–ç‰ˆ)</title>
    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --bg-color: #f4f1ea;
            --card-bg: #ffffff;
            --text-main: #4a4a4a;
            --text-sub: #8c8c8c;
            --primary-work: #a7d7c5;      /* å‡ºå‹¤ */
            --primary-work-dark: #7fb5a1; 
            --accent-off: #ffb7b2;        /* ä¼‘æ—¥ */
            --accent-public-off: #ef5350; /* æ³•ä¼‘ */
            --accent-off-dark: #e08e89;
            --accent-leave: #ffb74d;      /* æœ‰ä¼‘ */
            --accent-leave-dark: #f57c00;
            --accent-wish: #b71c1c;       /* å¸Œæœ›ä¼‘ (æ¿ƒã„èµ¤) */
            
            --status-error-bg: #ffebee;
            --status-error-text: #c62828;
            --status-warn-bg: #fff3e0;
            --status-warn-text: #e65100;
            --status-ok-bg: #e8f5e9;
            --status-ok-text: #2e7d32;
            --status-sync-bg: #e3f2fd;
            --status-sync-text: #1565c0;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh;
        }

        .app-container {
            width: 100%; max-width: 600px;
            background-color: var(--card-bg); border-radius: var(--radius);
            box-shadow: var(--shadow-card); overflow: hidden;
            display: flex; flex-direction: column; position: relative;
        }

        /* åŒæœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .cloud-section { padding: 12px 24px; background-color: #f8f9fa; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .cloud-header { font-size: 0.85rem; font-weight: 700; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center; }
        .cloud-controls { display: flex; gap: 8px; }
        .cloud-input { flex: 1; padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        .cloud-btn { padding: 6px 12px; background-color: var(--text-sub); color: white; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .cloud-btn:active { transform: scale(0.98); }
        .cloud-btn.primary { background-color: var(--primary-work-dark); }
        
        .sync-status { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background-color: #eee; color: #666; display: inline-flex; align-items: center; gap: 4px; }
        .sync-status.active { background-color: var(--status-sync-bg); color: var(--status-sync-text); }
        .sync-status.saved { background-color: var(--status-ok-bg); color: var(--status-ok-text); }
        .sync-status.error { background-color: var(--status-error-bg); color: var(--status-error-text); }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar { display: flex; gap: 8px; padding: 8px 24px; background-color: #fff; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tool-btn { flex: 1; white-space: nowrap; padding: 8px 12px; border: 1px solid #eee; border-radius: 6px; background-color: #fff; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
        .tool-btn:hover { background-color: #f9f9f9; }
        .tool-btn:active { background-color: #f0f0f0; }
        .tool-btn.active-tool { background-color: #fff3e0; border-color: #ffb74d; color: #f57c00; }
        .tool-btn.danger { color: #d32f2f; border-color: #ffcdd2; }
        .toolbar.locked .tool-btn { opacity: 0.5; pointer-events: none; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ & ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ‡æ›¿ */
        .header { padding: 16px 24px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .title-group { text-align: center; flex-grow: 1; display: flex; flex-direction: column; align-items: center; }
        .period-label { font-size: 1.1rem; font-weight: 700; color: var(--primary-work-dark); margin-bottom: 4px; }
        
        .month-title-wrapper { display: flex; justify-content: center; align-items: center; gap: 12px; }
        .month-title { font-size: 0.9rem; font-weight: 500; color: var(--text-sub); margin: 0; }
        
        /* A/Bãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .pattern-switch { display: flex; background-color: #f0f0f0; border-radius: 12px; padding: 2px; }
        .pattern-btn { border: none; background: transparent; padding: 4px 12px; font-size: 0.8rem; font-weight: 700; border-radius: 10px; cursor: pointer; color: #888; transition: all 0.2s; }
        .pattern-btn.active { background-color: var(--primary-work-dark); color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        .nav-btn { background: none; border: none; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* çµ±è¨ˆã‚¨ãƒªã‚¢ */
        .stats-bar { display: flex; justify-content: space-between; align-items: flex-end; padding: 12px 10px; background-color: #fff; border-bottom: 1px solid #eee; gap: 4px; overflow-x: auto; }
        .stat-item { display: flex; flex-direction: column; align-items: center; padding: 6px 8px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; min-width: 40px; background-color: #fff; transition: all 0.2s; }
        
        .stat-item[data-mode="work"] { border-color: var(--primary-work); }
        .stat-item[data-mode="wish_leave"] { border-color: var(--accent-wish); }
        .stat-item[data-mode="leave"] { border-color: var(--accent-leave); }
        .stat-item[data-mode="off"] { border-color: var(--accent-off); }
        .stat-item[data-mode="public_off"] { border-color: var(--accent-public-off); }
        
        .stat-item[data-mode="work"].active-mode { background-color: #eaf7f2; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-item[data-mode="wish_leave"].active-mode { background-color: #ffebee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-item[data-mode="leave"].active-mode { background-color: #fff8e1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-item[data-mode="off"].active-mode { background-color: #ffebee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-item[data-mode="public_off"].active-mode { background-color: #ffebee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-color: #e57373; }

        .stat-item.no-click { cursor: default; border-color: #eee; }
        .stats-bar.locked .stat-item:not(.no-click) { opacity: 0.6; pointer-events: none; border-color: #eee; background-color: transparent; }

        .stat-label-count { font-size: 0.65rem; color: var(--text-main); font-weight: 700; white-space: nowrap; }
        .stat-value { font-size: 1.1rem; font-weight: 700; line-height: 1.2; }
        .stat-work { color: var(--primary-work-dark); }
        .stat-wish { color: var(--accent-wish); }
        .stat-off { color: var(--accent-off-dark); }
        .stat-public-off { color: #d32f2f; }
        .stat-leave { color: var(--accent-leave-dark); }
        .input-field { width: 40px; text-align: center; border-radius: 6px; border: 1px solid #e0e0e0; font-weight: 700; }

        /* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ & ç·¨é›†ãƒ­ãƒƒã‚¯ã‚¨ãƒªã‚¢ */
        .validation-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 24px; background-color: #fafafa; border-top: 1px solid #eee; }
        .total-days-display { font-weight: 700; color: var(--text-main); font-size: 0.85rem; }
        .edit-switch { display: flex; background-color: #e0e0e0; border-radius: 20px; padding: 2px; }
        .switch-btn { padding: 4px 12px; border-radius: 18px; border: none; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; color: #666; background: transparent; }
        .switch-btn.active { background-color: #fff; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .switch-btn.active.edit-mode { color: var(--primary-work-dark); }

        .validation-messages { padding: 0 24px 8px 24px; background-color: #fafafa; display: flex; flex-direction: column; gap: 4px; }
        .error-message { color: var(--status-error-text); background-color: var(--status-error-bg); padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; }
        .warn-message { color: var(--status-warn-text); background-color: var(--status-warn-bg); padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 16px; }
        .weekday { text-align: center; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 8px; font-weight: 700; }
        .weekday:nth-child(1) { color: #d32f2f; }
        .weekday:nth-child(7) { color: #1565c0; }

        .day-cell { aspect-ratio: 1/1; border-radius: 8px; background-color: #f9f9f9; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 4px 2px; cursor: pointer; position: relative; font-weight: 500; overflow: hidden; transition: opacity 0.2s; }
        .day-cell.locked { cursor: default; }

        .day-cell.is-sun, .day-cell.is-holiday { color: #d32f2f !important; }
        .day-cell.is-sat { color: #1565c0; }
        .day-cell.outside-month { opacity: 0.4; background-color: #fff; }
        
        .day-cell.status-work { background-color: var(--primary-work); color: #fff; }
        .day-cell.status-leave { background-color: var(--accent-leave); color: #fff; }
        .day-cell.status-off { background-color: var(--accent-off); color: #fff; }
        .day-cell.status-public-off { background-color: var(--accent-public-off); color: #fff; }
        
        .day-cell.is-holiday, .day-cell.is-sun { font-weight: 700; }
        .day-cell.is-today { border: 2px solid var(--text-sub); }
        
        /* å¸Œæœ›ä¼‘ã®æ¿ƒã„èµ¤æ  */
        .day-cell.is-wish-leave { box-shadow: inset 0 0 0 3px var(--accent-wish); }

        /* æ—¥ä»˜æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
        .day-date { font-size: 0.85rem; font-weight: 700; margin-bottom: 1px; }

        /* ã®ã¼ã‚Šãƒãƒ¼ã‚¯ (â—) ã‚µã‚¤ã‚ºèª¿æ•´ */
        .nobori-mark { 
            margin-left: 2px; 
            font-size: 0.6rem; 
            color: #4a4a4a; 
            font-weight: normal; 
        }
        .day-cell[class*="status-"] .nobori-mark { color: #fff; }
        .day-cell.is-holiday .nobori-mark, .day-cell.is-sun .nobori-mark { color: #d32f2f; }

        .holiday-name { font-size: 0.5rem; line-height: 1; margin-top: 1px; text-align: center; color: #d32f2f; font-weight: 400; }
        .status-label { font-size: 0.7rem; font-weight: 700; margin-top: 1px; }
        
        /* ãƒ¡ãƒ¢è¡¨ç¤º */
        .note-text { 
            font-size: 0.9rem; 
            margin-top: 2px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 98%; 
            font-weight: 700; 
            opacity: 1; 
            color: #333;
            line-height: 1.1;
        }
        .day-cell[class*="status-"] .note-text { color: #fff; }

        /* è­¦å‘Šã‚¢ã‚¤ã‚³ãƒ³ */
        .warning-icon { 
            position: absolute; bottom: 2px; right: 2px; 
            font-size: 0.9rem; color: #ff9800; text-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.8; } }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 85%; max-width: 350px; }
        
        .modal-textarea { 
            width: 100%; height: 100px; padding: 10px; margin: 12px 0; 
            border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; 
            font-size: 1.1rem; resize: vertical; font-family: inherit;
        }
        
        .modal-input { width: 100%; padding: 10px; margin: 8px 0 16px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; font-size: 0.9rem; }
        .modal-btn.cancel { background-color: #eee; color: #666; }
        .modal-btn.save { background-color: var(--primary-work); color: #fff; }
        .modal-btn.danger { background-color: #d32f2f; color: #fff; }

        #copyStatusMsg { background-color: var(--status-ok-bg); color: var(--status-ok-text); position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; padding: 10px 20px; border-radius: 20px; display: none; box-shadow: var(--shadow-card); white-space: pre-wrap; text-align: center; line-height: 1.4;}
    </style>
</head>
<body>
    <div class="app-container">
        <div class="cloud-section">
            <div class="cloud-header"><span>â˜ï¸ ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­å®š</span><span id="syncStatus" class="sync-status">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span></div>
            <div class="cloud-controls">
                <input type="text" id="shareIdInput" class="cloud-input" placeholder="ID (ä¾‹ï¼šYamadaç­‰)">
                <input type="password" id="passwordInput" class="cloud-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            </div>
            <div class="cloud-controls" style="margin-top: 4px;">
                <button id="registerBtn" class="cloud-btn primary" style="flex: 1;">æ–°è¦ç™»éŒ²</button>
                <button id="connectBtn" class="cloud-btn" style="flex: 1;">èª­è¾¼</button>
            </div>
            <div id="debugError" style="font-size: 10px; color: red; margin-top: 4px; display: none;"></div>
        </div>
        
        <div class="toolbar locked" id="mainToolbar">
            <button class="tool-btn" id="noboriBtn">â— æ‹ ç‚¹ç©</button>
            <button class="tool-btn" id="memoModeBtn">ğŸ“ äºˆå®š</button>
            <button class="tool-btn" id="copyTextBtn">ğŸ“‹ å‡ºåŠ›</button>
            <button class="tool-btn" id="settingsBtn">âš™ï¸ è¨­å®š</button>
            <button class="tool-btn danger" id="resetAllBtn">â™»ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="header">
            <button class="nav-btn" id="prevBtn">â®</button>
            <div class="title-group">
                <div class="period-label" id="periodLabel"></div>
                <div class="month-title-wrapper">
                    <h2 class="month-title" id="currentPeriodDisplay">èª­ã¿è¾¼ã¿ä¸­...</h2>
                    <div class="pattern-switch">
                        <button class="pattern-btn" id="patternA">A</button>
                        <button class="pattern-btn" id="patternB">B</button>
                    </div>
                </div>
            </div>
            <button class="nav-btn" id="nextBtn">â¯</button>
        </div>

        <div class="stats-bar locked" id="mainStatsBar">
            <div class="stat-item no-click"><label class="stat-label-count">æ‰€å®šæ—¥æ•°</label><input type="number" id="requiredDaysInput" class="input-field"></div>
            <div class="stat-item" id="modeWork" data-mode="work"><span class="stat-label-count">å‡ºå‹¤</span><span class="stat-value stat-work" id="workCount">0</span></div>
            <div class="stat-item" id="modeWishLeave" data-mode="wish_leave"><span class="stat-label-count">å¸Œæœ›ä¼‘</span><span class="stat-value stat-wish">-</span></div>
            <div class="stat-item" id="modeLeave" data-mode="leave"><span class="stat-label-count">æœ‰ä¼‘</span><span class="stat-value stat-leave" id="leaveCount">0</span></div>
            <div class="stat-item" id="modeOff" data-mode="off"><span class="stat-label-count">ä¼‘æ—¥</span><span class="stat-value stat-off" id="offCount">0</span></div>
            <div class="stat-item" id="modePublicOff" data-mode="public_off"><span class="stat-label-count">æ³•ä¼‘</span><span class="stat-value stat-public-off" id="publicOffCount">0</span></div>
        </div>

        <div class="validation-header">
            <div class="total-days-display" id="totalDaysDisplay"></div>
            <div class="edit-switch">
                <button class="switch-btn" id="lockBtn">ãƒ­ãƒƒã‚¯</button>
                <button class="switch-btn" id="editBtn">ç·¨é›†</button>
            </div>
        </div>
        <div class="validation-messages" id="statusMessageContainer"></div>

        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div id="copyStatusMsg"></div>

    <!-- ãƒ¡ãƒ¢ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="memoModal">
        <div class="modal-content">
            <div id="modalTitle" style="font-weight:700; margin-bottom:10px;"></div>
            <textarea id="memoInput" class="modal-textarea" placeholder="äºˆå®šã‚’å…¥åŠ› (ä¾‹ï¼šå®‰å…¨ä¼šè­° etc)"></textarea>
            <div style="display:flex;justify-content:flex-end;gap:8px;">
                <button class="modal-btn cancel" id="memoCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn save" id="memoSaveBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <h3 style="margin-top:0;">è¨­å®š</h3>
            <p style="font-size:0.8rem; color:#666;">å‡ºåŠ›æ™‚ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰ã®å®›å…ˆã¨ãªã‚‹ã€é…è»Šä¿‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã€ä»¶åã«è¡¨ç¤ºã™ã‚‹ãŠåå‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
            <label style="font-size:0.85rem; font-weight:bold;">ã‚ãªãŸã®ãŠåå‰ï¼ˆä»¶åã«è¡¨ç¤ºï¼‰</label>
            <input type="text" id="senderNameInput" class="modal-input" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ">
            <label style="font-size:0.85rem; font-weight:bold;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ 1</label>
            <input type="email" id="email1Input" class="modal-input" placeholder="ä¾‹ï¼šhaisha1@example.com">
            <label style="font-size:0.85rem; font-weight:bold;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ 2 (ä»»æ„)</label>
            <input type="email" id="email2Input" class="modal-input" placeholder="ä¾‹ï¼šhaisha2@example.com">
            <div style="display:flex;justify-content:flex-end;gap:8px;">
                <button class="modal-btn cancel" id="settingsCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn save" id="settingsSaveBtn">ä¿å­˜</button>
            </div>
            
            <div style="margin-top:20px; padding-top:15px; border-top: 1px solid #eee;">
                <p style="font-size:0.8rem; color:#d32f2f; font-weight:bold; margin-bottom: 8px;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>
                <button class="modal-btn danger" id="allClearBtn" style="width: 100%;">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–</button>
            </div>
        </div>
    </div>
    
    <!-- ç¢ºèªç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <h3>ç¢ºèª</h3>
            <div id="confirmMessage" style="margin-bottom:15px; font-size:0.9rem; white-space:pre-wrap;"></div>
            <div style="display:flex;justify-content:flex-end;gap:8px;">
                <button class="modal-btn cancel" id="confirmCancelBtn">ã‚„ã‚ã‚‹</button>
                <button class="modal-btn danger" id="confirmOkBtn">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal-content">
            <h3 id="alertTitle" style="margin-top:0; color:var(--status-error-text);">ãŠçŸ¥ã‚‰ã›</h3>
            <div id="alertMessage" style="margin-bottom:20px; font-size:0.95rem; white-space:pre-wrap; line-height:1.4;"></div>
            <div style="display:flex;justify-content:flex-end;">
                <button class="modal-btn save" onclick="document.getElementById('alertModal').classList.remove('active')">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDQ3fJpKeoQ6-mjsQGni8YlI8NH-Dp-JE0",
            authDomain: "ka-shift-calendar.firebaseapp.com",
            projectId: "ka-shift-calendar",
            storageBucket: "ka-shift-calendar.firebasestorage.app",
            messagingSenderId: "740196147233",
            appId: "1:740196147233:web:8e0c59b466f515fb2c8360",
            measurementId: "G-45CWYB75NE"
        };

        const appId = 'ka-shift-manager-v1';
        let db, auth, user, unsubscribeDoc = null, isCloudActive = false, saveTimeout = null, confirmCallback = null, currentMemoKey = null;
        let autoLockTimer = null;

        function safeParse(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error("Local storage parsing error for " + key, e);
                return defaultValue;
            }
        }

        const state = {
            currentStartDate: new Date(),
            currentPattern: localStorage.getItem('currentPattern') || 'A',
            
            password: localStorage.getItem('lastPassword') || '',

            attendance: safeParse('attendanceData', {}),
            markers: safeParse('markersData', {}), 
            attendance_B: safeParse('attendanceData_B', {}),
            markers_B: safeParse('markersData_B', {}), 
            
            requiredDays: safeParse('requiredDaysData', {}),
            notes: safeParse('notesData', {}),
            wishLeaves: safeParse('wishLeavesData', {}), 
            settings: safeParse('settingsData', { email1: '', email2: '', senderName: '' }), 
            
            selectedMode: null,
            isLocked: true 
        };

        const getAtt = () => state.currentPattern === 'A' ? state.attendance : state.attendance_B;
        const getMar = () => state.currentPattern === 'A' ? state.markers : state.markers_B;

        function formatDateKey(d) { return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`; }
        function initDate() { const today = new Date(); if (today.getDate() <= 15) state.currentStartDate = new Date(today.getFullYear(), today.getMonth()-1, 16); else state.currentStartDate = new Date(today.getFullYear(), today.getMonth(), 16); }

        function showAlert(msg, title = 'ãŠçŸ¥ã‚‰ã›') {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = msg;
            document.getElementById('alertModal').classList.add('active');
        }

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    const sid = localStorage.getItem('lastShareId');
                    const pwd = localStorage.getItem('lastPassword');
                    if (user && sid) { 
                        document.getElementById('shareIdInput').value = sid; 
                        if (pwd) {
                            document.getElementById('passwordInput').value = pwd;
                            state.password = pwd;
                        }
                        connect(sid); 
                    }
                });
            } catch (e) {
                showError("è¨­å®šã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        function showError(msg) {
            const el = document.getElementById('debugError');
            el.textContent = msg; el.style.display = 'block';
            document.getElementById('syncStatus').textContent = "ã‚¨ãƒ©ãƒ¼";
            document.getElementById('syncStatus').className = "sync-status error";
        }

        // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»˜ãï¼‰
        document.getElementById('registerBtn').onclick = () => {
            const sid = document.getElementById('shareIdInput').value.trim();
            const pwd = document.getElementById('passwordInput').value.trim();
            if (!sid || !pwd) { 
                showAlert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); 
                return; 
            }
            if (!user || !db) return;

            document.getElementById('confirmMessage').textContent = `IDã€Œ${sid}ã€ã§æ–°ã—ãã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã®IDã‚’é–‹ãå ´åˆã¯ã€ã“ã®ãƒœã‚¿ãƒ³ã§ã¯ãªãã€Œèª­è¾¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
            document.getElementById('confirmModal').classList.add('active');
            
            confirmCallback = async () => {
                if (unsubscribeDoc) unsubscribeDoc();
                document.getElementById('syncStatus').textContent = "ç¢ºèªä¸­...";
                document.getElementById('syncStatus').className = "sync-status active";

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        showAlert("ã“ã®IDã¯æ—¢ã«ä»–ã®äººã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\nåˆ¥ã®IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚\nï¼ˆã”è‡ªèº«ã®IDã‚’èª­ã¿è¾¼ã‚€å ´åˆã¯ã€Œèª­è¾¼ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰");
                        document.getElementById('syncStatus').textContent = "ã‚¨ãƒ©ãƒ¼";
                        document.getElementById('syncStatus').className = "sync-status error";
                    } else {
                        isCloudActive = true; 
                        localStorage.setItem('lastShareId', sid);
                        localStorage.setItem('lastPassword', pwd);
                        state.password = pwd;
                        
                        // æ–°è¦ç™»éŒ²æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¦ç©ºã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
                        state.attendance = {};
                        state.markers = {};
                        state.attendance_B = {};
                        state.markers_B = {};
                        state.requiredDays = {};
                        state.notes = {};
                        state.wishLeaves = {};
                        state.settings = { email1: '', email2: '', senderName: '' };
                        
                        const data = { 
                            password: pwd, 
                            attendance: state.attendance, 
                            markers: state.markers, 
                            attendance_B: state.attendance_B,
                            markers_B: state.markers_B,
                            requiredDays: state.requiredDays, 
                            notes: state.notes, 
                            wishLeaves: state.wishLeaves,
                            settings: state.settings,
                            updatedAt: new Date().toISOString() 
                        };
                        await setDoc(docRef, data);
                        showAlert(`IDã€Œ${sid}ã€ã§æ–°ã—ãç™»éŒ²ã—ã¾ã—ãŸï¼\nã“ã®IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä»–ã®ç«¯æœ«ã‹ã‚‰é–‹ãéš›ã«ã‚‚å¿…è¦ã§ã™ã€‚`);
                        connect(sid);
                    }
                } catch(e) {
                    showError("ã‚¨ãƒ©ãƒ¼: " + e.message);
                }
            };
        };

        // èª­è¾¼ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆå³å¯†ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼‰
        document.getElementById('connectBtn').onclick = async () => {
            const sid = document.getElementById('shareIdInput').value.trim();
            const pwd = document.getElementById('passwordInput').value.trim();
            if (!sid || !pwd) { 
                showAlert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); 
                return; 
            }
            if (!user || !db) return;

            if (unsubscribeDoc) unsubscribeDoc();
            document.getElementById('syncStatus').textContent = "ç¢ºèªä¸­...";
            document.getElementById('syncStatus').className = "sync-status active";

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    showAlert("ç™»éŒ²ã•ã‚Œã¦ã„ãªã„IDã§ã™ã€‚\nIDã«é–“é•ã„ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nåˆã‚ã¦ã®å ´åˆã¯ã€Œæ–°è¦ç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                    document.getElementById('syncStatus').textContent = "ã‚¨ãƒ©ãƒ¼";
                    document.getElementById('syncStatus').className = "sync-status error";
                } else {
                    const data = docSnap.data();
                    const serverPwd = data.password || ""; // ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                    
                    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå®Œå…¨ä¸€è‡´ã—ãªã„ã¨å¼¾ã
                    if (serverPwd !== pwd) {
                        showAlert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚\næ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                        document.getElementById('syncStatus').textContent = "ã‚¨ãƒ©ãƒ¼";
                        document.getElementById('syncStatus').className = "sync-status error";
                        return;
                    }
                    
                    localStorage.setItem('lastPassword', pwd);
                    state.password = pwd;
                    connect(sid);
                }
            } catch(e) {
                showError("ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        };

        function connect(sid) {
            if (!user || !db || !sid) return;
            if (unsubscribeDoc) unsubscribeDoc();
            isCloudActive = true; localStorage.setItem('lastShareId', sid);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            document.getElementById('syncStatus').textContent = "æ¥ç¶šä¸­...";
            document.getElementById('syncStatus').className = "sync-status active";
            
            unsubscribeDoc = onSnapshot(docRef, (snap) => {
                if (snap.metadata.hasPendingWrites) return;
                if (snap.exists()) {
                    const data = snap.data();
                    const serverPwd = data.password || "";
                    
                    // è‡ªå‹•æ¥ç¶šæ™‚ãªã©ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„å ´åˆã¯å¼¾ãï¼ˆä»–ç«¯æœ«ã§ã®ä¸æ­£å¤‰æ›´é˜²æ­¢ç­‰ï¼‰
                    if (state.password !== serverPwd) {
                        isCloudActive = false;
                        if (unsubscribeDoc) unsubscribeDoc();
                        showAlert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\næ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€Œèª­è¾¼ã€ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
                        document.getElementById('syncStatus').className = 'sync-status error';
                        document.getElementById('syncStatus').textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼';
                        return;
                    }

                    state.attendance = data.attendance || {}; 
                    state.markers = data.markers || {};
                    state.attendance_B = data.attendance_B || {}; 
                    state.markers_B = data.markers_B || {};
                    
                    state.requiredDays = data.requiredDays || {};
                    state.notes = data.notes || {}; 
                    state.wishLeaves = data.wishLeaves || {};
                    state.settings = data.settings || { email1: '', email2: '', senderName: '' };
                    render();
                    document.getElementById('syncStatus').className = 'sync-status saved';
                    document.getElementById('syncStatus').textContent = 'åŒæœŸä¸­';
                    document.getElementById('debugError').style.display = 'none';
                } else { 
                    isCloudActive = false;
                    document.getElementById('syncStatus').className = 'sync-status error';
                    document.getElementById('syncStatus').textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                }
            }, (err) => { 
                showError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.code); 
            });
        }

        function save(immediate = false) {
            localStorage.setItem('attendanceData', JSON.stringify(state.attendance));
            localStorage.setItem('markersData', JSON.stringify(state.markers));
            localStorage.setItem('attendanceData_B', JSON.stringify(state.attendance_B));
            localStorage.setItem('markersData_B', JSON.stringify(state.markers_B));
            
            localStorage.setItem('requiredDaysData', JSON.stringify(state.requiredDays));
            localStorage.setItem('notesData', JSON.stringify(state.notes));
            localStorage.setItem('wishLeavesData', JSON.stringify(state.wishLeaves));
            localStorage.setItem('settingsData', JSON.stringify(state.settings));
            localStorage.setItem('currentPattern', state.currentPattern);
            
            if (!isCloudActive || !user) return;
            const sid = document.getElementById('shareIdInput').value;
            if(!sid) return;
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shifts', sid);
            const data = { 
                password: state.password || '', 
                attendance: state.attendance, 
                markers: state.markers, 
                attendance_B: state.attendance_B,
                markers_B: state.markers_B,
                requiredDays: state.requiredDays, 
                notes: state.notes, 
                wishLeaves: state.wishLeaves,
                settings: state.settings,
                updatedAt: new Date().toISOString() 
            };
            if (saveTimeout) clearTimeout(saveTimeout);
            const doSave = () => { setDoc(docRef, data).catch(err => showError("ä¿å­˜ã‚¨ãƒ©ãƒ¼")); };
            if (immediate) doSave(); else saveTimeout = setTimeout(doSave, 800);
        }

        function resetAutoLockTimer() {
            clearTimeout(autoLockTimer);
            if (!state.isLocked) {
                autoLockTimer = setTimeout(() => {
                    state.isLocked = true;
                    state.selectedMode = null;
                    render();
                }, 10 * 60 * 1000); 
            }
        }

        const Holidays = {
            getEquinox: (y, t) => Math.floor(((t==='v')?20.8431:23.2488) + 0.242194 * (y-1980) - Math.floor((y-1980)/4)),
            getMap: function(s, e) {
                const h = {}, d = new Date(s); d.setDate(d.getDate()-7); const end = new Date(e); end.setDate(end.getDate()+7);
                while(d <= end) { 
                    const y=d.getFullYear(), m=d.getMonth()+1, date=d.getDate(), w=d.getDay(), nth=Math.ceil(date/7);
                    let name = null;
                    if(m===1&&date===1)name="å…ƒæ—¥";else if(m===2&&date===11)name="å»ºå›½";else if(m===2&&date===23)name="å¤©çš‡";
                    else if(m===4&&date===29)name="æ˜­å’Œ";else if(m===5&&date===3)name="æ†²æ³•";else if(m===5&&date===4)name="ç·‘";
                    else if(m===5&&date===5)name="å­ä¾›";else if(m===8&&date===11)name="å±±";else if(m===11&&date===3)name="æ–‡åŒ–";else if(m===11&&date===23)name="å‹¤åŠ´";
                    else if(w===1){if(m===1&&nth===2)name="æˆäºº";if(m===7&&nth===3)name="æµ·";if(m===9&&nth===3)name="æ•¬è€";if(m===10&&nth===2)name="ã‚¹ãƒãƒ¼ãƒ„";}
                    if(m===3&&date===this.getEquinox(y,'v'))name="æ˜¥åˆ†";if(m===9&&date===this.getEquinox(y,'a'))name="ç§‹åˆ†";
                    if(name) h[formatDateKey(d)] = name; d.setDate(d.getDate()+1);
                }
                d.setTime(s.getTime()); d.setDate(d.getDate()-7);
                while(d <= end) { if(h[formatDateKey(d)] && d.getDay()===0) { let o=1; while(o<10){ const n=new Date(d); n.setDate(d.getDate()+o); if(h[formatDateKey(n)])o++; else{h[formatDateKey(n)]="æŒ¯æ›¿";break;} } } d.setDate(d.getDate()+1); }
                return h;
            }
        };

        function initMonthDataIfEmpty(start, end) {
            let hasData = false;
            let l = new Date(start);
            const att = getAtt();
            while(l <= end){
                if(att[formatDateKey(l)]) { hasData = true; break; }
                l.setDate(l.getDate()+1);
            }
            if(!hasData) {
                const h = Holidays.getMap(start, end);
                l = new Date(start);
                while(l <= end){
                    const k = formatDateKey(l);
                    const day = l.getDay();
                    if(day === 0 || day === 6 || h[k]) att[k] = 'off'; 
                    else att[k] = 'work';
                    l.setDate(l.getDate()+1);
                }
                save(); 
            }
        }

        function checkNoboriAlerts(start, end) {
            const alerts = [];
            let loop = new Date(start);
            const att = getAtt();
            const mar = getMar();
            while(loop <= end) {
                const k = formatDateKey(loop);
                const currentStatus = att[k];
                const hasMarker = mar[k];

                if (currentStatus === 'work' && !hasMarker) {
                    const next = new Date(loop);
                    next.setDate(loop.getDate() + 1);
                    const nextK = formatDateKey(next);
                    const nextStatus = att[nextK];
                    const nextMarker = mar[nextK];
                    
                    const isDepartureDay = (nextStatus === 'work' && !nextMarker);

                    if (!isDepartureDay) {
                        const prev = new Date(loop);
                        prev.setDate(loop.getDate() - 1);
                        const prevK = formatDateKey(prev);
                        const prevStatus = att[prevK];
                        
                        if (prevStatus && prevStatus !== 'work') {
                            alerts.push({ msg: `${loop.getDate()}æ—¥ å‡ºå‹¤ï¼Ÿ` });
                        }
                    }
                }
                
                if (currentStatus === 'work' && !hasMarker) {
                     const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                     const prev2 = new Date(loop); prev2.setDate(loop.getDate() - 2);
                     const pk = formatDateKey(prev);
                     const pk2 = formatDateKey(prev2);
                     if (att[pk] === 'work' && !mar[pk] &&
                         att[pk2] === 'work' && !mar[pk2]) {
                         alerts.push({ msg: `${loop.getDate()}æ—¥ å‡ºå‹¤ï¼Ÿ(3é€£)` });
                     }
                }

                if (currentStatus !== 'work') {
                    const next = new Date(loop);
                    next.setDate(loop.getDate() + 1);
                    if (next <= end) {
                        const nextK = formatDateKey(next);
                        const nextStatus = att[nextK];
                        if (!nextStatus && checkIsLoading(loop)) {
                             alerts.push({ msg: `${loop.getDate()}æ—¥ ç¢ºèª` });
                        }
                    }
                }

                loop.setDate(loop.getDate()+1);
            }
            return alerts;
        }

        function checkIsLoading(currentDate) {
            const att = getAtt();
            const mar = getMar();
            for (let i = 1; i <= 7; i++) {
                const prev = new Date(currentDate);
                prev.setDate(currentDate.getDate() - i);
                const prevK = formatDateKey(prev);
                const status = att[prevK];
                if (status === 'work' || status === 'leave' || status === 'off') {
                    if (mar[prevK]) return true; 
                    if (status === 'work' && !mar[prevK]) return false; 
                }
            }
            return false;
        }

        function getWarningDates(start, end) {
            const warnings = new Set();
            let loop = new Date(start);
            const att = getAtt();
            const mar = getMar();
            while(loop <= end) {
                const k = formatDateKey(loop);
                const status = att[k];
                const marker = mar[k];

                if (status === 'work' && !marker) {
                     const next = new Date(loop);
                     next.setDate(loop.getDate() + 1);
                     const nextK = formatDateKey(next);
                     const nextStatus = att[nextK];
                     const nextMarker = mar[nextK];
                     
                     const isDepartureDay = (nextStatus === 'work' && !nextMarker);

                     if (!isDepartureDay) {
                         const prev = new Date(loop);
                         prev.setDate(loop.getDate() - 1);
                         const prevK = formatDateKey(prev);
                         const prevStatus = att[prevK];
                         
                         if (prevStatus && prevStatus !== 'work') {
                             warnings.add(prevK);
                         }
                     }
                }

                if (status === 'work' && !marker) {
                     const prev = new Date(loop); prev.setDate(loop.getDate() - 1);
                     const prev2 = new Date(loop); prev2.setDate(loop.getDate() - 2);
                     const pk = formatDateKey(prev);
                     const pk2 = formatDateKey(prev2);
                     
                     if (att[pk] === 'work' && !mar[pk] &&
                         att[pk2] === 'work' && !mar[pk2]) {
                         warnings.add(k);
                     }
                }

                if (status !== 'work') {
                    const next = new Date(loop);
                    next.setDate(loop.getDate() + 1);
                    if (next <= end) {
                        const nextK = formatDateKey(next);
                        const nextStatus = att[nextK];
                        if (!nextStatus && checkIsLoading(loop)) {
                             warnings.add(k);
                        }
                    }
                }

                loop.setDate(loop.getDate() + 1);
            }
            return warnings;
        }

        function render() {
            document.getElementById('patternA').classList.toggle('active', state.currentPattern === 'A');
            document.getElementById('patternB').classList.toggle('active', state.currentPattern === 'B');

            updateLockStateUI();
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const start = new Date(state.currentStartDate), end = new Date(start.getFullYear(), start.getMonth()+1, 15);
            
            initMonthDataIfEmpty(start, end);

            document.getElementById('periodLabel').textContent = `${end.getMonth()+1}æœˆåº¦`;
            document.getElementById('currentPeriodDisplay').textContent = `${start.getFullYear()}å¹´${start.getMonth()+1}æœˆ${start.getDate()}æ—¥ - ${end.getMonth()+1}æœˆ${end.getDate()}æ—¥`;
            
            const pk = formatDateKey(start); document.getElementById('requiredDaysInput').value = state.requiredDays[pk] || '';
            const holMap = Holidays.getMap(start, end);
            
            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => { const div=document.createElement('div'); div.className='weekday'; div.textContent=d; grid.appendChild(div); });
            
            const warningDates = getWarningDates(start, end);

            const startDay = start.getDay(); 
            for (let i = startDay; i > 0; i--) {
                const prevDate = new Date(start); prevDate.setDate(start.getDate() - i);
                createDayCell(prevDate, holMap, true, null, null, warningDates);
            }

            let loop = new Date(start), counts = { w:0, l:0, o:0, po:0, t:0 }, todayKey = formatDateKey(new Date());
            while (loop <= end) {
                createDayCell(loop, holMap, false, counts, todayKey, warningDates);
                loop.setDate(loop.getDate()+1);
            }

            const endDay = end.getDay();
            for (let i = 1; i < 7 - endDay; i++) {
                const nextDate = new Date(end); nextDate.setDate(end.getDate() + i);
                createDayCell(nextDate, holMap, true, null, null, warningDates);
            }

            document.getElementById('workCount').textContent=counts.w; 
            document.getElementById('leaveCount').textContent=counts.l; 
            document.getElementById('offCount').textContent=counts.o; 
            document.getElementById('publicOffCount').textContent=counts.po;
            
            const v = document.getElementById('statusMessageContainer'); v.innerHTML = ''; document.getElementById('totalDaysDisplay').textContent = `å…¨ä½“: ${counts.t}æ—¥`;
            const fill = counts.w+counts.l+counts.o+counts.po; 
            if (fill!==counts.t) { const d=document.createElement('div'); d.className='error-message'; d.textContent=`æœªå…¥åŠ›ãŒ ${counts.t-fill}æ—¥ ã‚ã‚Šã¾ã™ã€‚`; v.appendChild(d); }
            const req = parseInt(state.requiredDays[pk]||0); 
            if(req>0){ 
                const act = counts.w + counts.l; 
                if(act<req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`ä¸è¶³: ${req-act}æ—¥`; v.appendChild(d); }
                else if(act>req){ const d=document.createElement('div'); d.className='error-message'; d.textContent=`è¶…é: ${act-req}æ—¥`; v.appendChild(d); } 
            }
            
            const alerts = checkNoboriAlerts(start, end);
            alerts.forEach(a => {
                const d = document.createElement('div'); 
                d.className='warn-message'; 
                d.textContent = `âš ï¸ ${a.msg}`; 
                v.appendChild(d);
            });

            document.querySelectorAll('.stat-item[data-mode]').forEach(el => el.classList.toggle('active-mode', el.dataset.mode===state.selectedMode));
            document.getElementById('noboriBtn').classList.toggle('active-tool', state.selectedMode==='nobori');
        }

        function openMemoModal(dateKey) {
            currentMemoKey = dateKey;
            const existingNote = state.notes[dateKey] || "";
            document.getElementById('modalTitle').textContent = `${dateKey} ã®äºˆå®š`;
            document.getElementById('memoInput').value = existingNote;
            document.getElementById('memoModal').classList.add('active');
            document.getElementById('memoInput').focus();
        }

        function createDayCell(dateObj, holMap, isOutside, counts = null, todayKey = null, warningDates = new Set()) {
            const k = formatDateKey(dateObj);
            const att = getAtt();
            const mar = getMar();
            
            const s = att[k];
            const hol = holMap[k];
            const n = state.notes[k];
            const m = mar[k];
            const wl = state.wishLeaves[k];
            
            const cell = document.createElement('div'); 
            cell.className = 'day-cell';
            if (isOutside) cell.classList.add('outside-month');
            if (state.isLocked) cell.classList.add('locked'); 
            
            if (wl) cell.classList.add('is-wish-leave');

            const dWrap = document.createElement('div'); dWrap.style.display = "flex"; dWrap.style.alignItems = "center";
            const dNum = document.createElement('span'); 
            dNum.className = 'day-date'; 
            dNum.textContent = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`; 
            dWrap.appendChild(dNum);

            if (m) { const sp=document.createElement('span'); sp.className='nobori-mark'; sp.textContent='â—'; dWrap.appendChild(sp); }
            cell.appendChild(dWrap);
            
            if (hol) cell.classList.add('is-holiday'); 
            else if (dateObj.getDay()===0) cell.classList.add('is-sun'); 
            else if (dateObj.getDay()===6) cell.classList.add('is-sat');

            if (hol) { const hName = document.createElement('span'); hName.className = 'holiday-name'; hName.textContent = hol; cell.appendChild(hName); }
            if (s==='leave') { const l=document.createElement('span'); l.className='status-label'; l.textContent='æœ‰ä¼‘'; cell.appendChild(l); }
            if (n) { const ns=document.createElement('span'); ns.className='note-text'; ns.textContent=n; cell.appendChild(ns); }
            
            if (k === todayKey) cell.classList.add('is-today');
            
            if (s==='work') { cell.classList.add('status-work'); if(counts) counts.w++; }
            else if (s==='leave') { cell.classList.add('status-leave'); if(counts) counts.l++; }
            else if (s==='off') { cell.classList.add('status-off'); if(counts) counts.o++; }
            else if (s==='public_off') { cell.classList.add('status-public-off'); if(counts) counts.po++; }
            
            if(counts) counts.t++;

            if (warningDates.has(k)) {
                const warnIcon = document.createElement('span');
                warnIcon.className = 'warning-icon';
                warnIcon.textContent = 'âš ï¸';
                cell.appendChild(warnIcon);
            }

            cell.onclick = () => { 
                if (state.isLocked) return;
                resetAutoLockTimer(); 

                if (state.selectedMode === 'memo') {
                    openMemoModal(k);
                } else if (state.selectedMode === 'wish_leave') {
                    if (state.wishLeaves[k]) delete state.wishLeaves[k];
                    else state.wishLeaves[k] = true;
                    save(); render();
                } else if (state.selectedMode === 'nobori') {
                    if (mar[k]) delete mar[k]; 
                    else mar[k] = true;
                    save(); render();
                } else if (!isOutside) {
                    if (state.selectedMode) {
                        if (att[k] === state.selectedMode) delete att[k];
                        else att[k] = state.selectedMode;
                    } else {
                        const cycle = [null, 'work', 'leave', 'off', 'public_off'];
                        const curIdx = cycle.indexOf(att[k] || null);
                        const nextStatus = cycle[(curIdx + 1) % cycle.length];
                        if (nextStatus) att[k] = nextStatus; else delete att[k];
                    }
                    save(); render();
                }
            };
            
            document.getElementById('calendarGrid').appendChild(cell);
        }

        function updateLockStateUI() {
            const lockBtn = document.getElementById('lockBtn');
            const editBtn = document.getElementById('editBtn');
            const toolbar = document.getElementById('mainToolbar');
            const statsBar = document.getElementById('mainStatsBar');
            const requiredInput = document.getElementById('requiredDaysInput');

            if (state.isLocked) {
                lockBtn.classList.add('active');
                editBtn.classList.remove('active', 'edit-mode');
                toolbar.classList.add('locked');
                statsBar.classList.add('locked');
                requiredInput.disabled = true;
            } else {
                lockBtn.classList.remove('active');
                editBtn.classList.add('active', 'edit-mode');
                toolbar.classList.remove('locked');
                statsBar.classList.remove('locked');
                requiredInput.disabled = false;
            }
        }

        document.getElementById('lockBtn').onclick = () => { 
            state.isLocked = true; 
            state.selectedMode = null; 
            clearTimeout(autoLockTimer);
            render(); 
        };
        document.getElementById('editBtn').onclick = () => { 
            state.isLocked = false; 
            render(); 
            resetAutoLockTimer();
        };

        // ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ‡æ›¿ãƒœã‚¿ãƒ³
        document.getElementById('patternA').onclick = () => {
            state.currentPattern = 'A';
            localStorage.setItem('currentPattern', 'A');
            render();
        };
        document.getElementById('patternB').onclick = () => {
            state.currentPattern = 'B';
            localStorage.setItem('currentPattern', 'B');
            render();
        };

        document.getElementById('prevBtn').onclick = () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()-1); render(); };
        document.getElementById('nextBtn').onclick = () => { state.currentStartDate.setMonth(state.currentStartDate.getMonth()+1); render(); };
        
        document.getElementById('requiredDaysInput').oninput = (e) => { const k=formatDateKey(state.currentStartDate); if(e.target.value) state.requiredDays[k]=parseInt(e.target.value); else delete state.requiredDays[k]; save(); render(); };
        
        document.getElementById('settingsBtn').onclick = () => {
            if (state.isLocked) return;
            resetAutoLockTimer();
            document.getElementById('senderNameInput').value = state.settings.senderName || '';
            document.getElementById('email1Input').value = state.settings.email1 || '';
            document.getElementById('email2Input').value = state.settings.email2 || '';
            document.getElementById('settingsModal').classList.add('active');
        };
        document.getElementById('settingsCancelBtn').onclick = () => document.getElementById('settingsModal').classList.remove('active');
        document.getElementById('settingsSaveBtn').onclick = () => {
            state.settings.senderName = document.getElementById('senderNameInput').value.trim();
            state.settings.email1 = document.getElementById('email1Input').value.trim();
            state.settings.email2 = document.getElementById('email2Input').value.trim();
            save();
            document.getElementById('settingsModal').classList.remove('active');
        };

        document.getElementById('resetAllBtn').onclick = () => {
            if(state.isLocked) return; 
            resetAutoLockTimer();
            const endMonth = state.currentStartDate.getMonth() + 2 > 12 ? (state.currentStartDate.getMonth() + 2) - 12 : state.currentStartDate.getMonth() + 2;
            const pLabel = state.currentPattern;
            document.getElementById('confirmMessage').textContent = `ã€Œ${endMonth}æœˆåº¦ (ãƒ‘ã‚¿ãƒ¼ãƒ³${pLabel})ã€ã‚’åˆæœŸçŠ¶æ…‹ï¼ˆå¹³æ—¥å‡ºå‹¤ãƒ»åœŸæ—¥ç¥ä¼‘ã¿ï¼‰ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®å…¥åŠ›å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ãŒã€äºˆå®šã¯æ®‹ã‚Šã¾ã™ï¼‰`;
            document.getElementById('confirmModal').classList.add('active');
            confirmCallback = () => {
                const s = new Date(state.currentStartDate), e = new Date(s.getFullYear(), s.getMonth()+1, 15);
                const att = getAtt();
                const mar = getMar();
                let l = new Date(s);
                while(l <= e){
                    const k = formatDateKey(l);
                    delete att[k];
                    delete mar[k];
                    delete state.wishLeaves[k]; 
                    l.setDate(l.getDate()+1);
                }
                save(true);
                render();
            };
        };

        document.getElementById('allClearBtn').onclick = () => {
            if (state.isLocked) return;
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('confirmMessage').textContent = `ã€è­¦å‘Šã€‘ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆA/Bä¸¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚·ãƒ•ãƒˆã€äºˆå®šã€å¸Œæœ›ä¼‘ãªã©ï¼‰ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\nâ€»è¨­å®šã¯æ®‹ã‚Šã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
            document.getElementById('confirmModal').classList.add('active');
            confirmCallback = () => {
                state.attendance = {};
                state.markers = {};
                state.attendance_B = {};
                state.markers_B = {};
                state.notes = {};
                state.wishLeaves = {};
                state.requiredDays = {};
                save(true);
                render();
            };
        };
        
        document.getElementById('confirmOkBtn').onclick = () => { if(confirmCallback) confirmCallback(); document.getElementById('confirmModal').classList.remove('active'); };
        document.getElementById('confirmCancelBtn').onclick = () => { document.getElementById('confirmModal').classList.remove('active'); };
        
        document.getElementById('noboriBtn').onclick = () => { state.selectedMode = state.selectedMode==='nobori'?null:'nobori'; render(); };
        document.getElementById('memoModeBtn').onclick = () => { state.selectedMode = state.selectedMode==='memo'?null:'memo'; render(); };
        
        document.getElementById('memoCancelBtn').onclick = () => document.getElementById('memoModal').classList.remove('active');
        document.getElementById('memoSaveBtn').onclick = () => { const v = document.getElementById('memoInput').value.trim(); if(v) state.notes[currentMemoKey] = v; else delete state.notes[currentMemoKey]; save(); render(); document.getElementById('memoModal').classList.remove('active'); };
        
        document.getElementById('copyTextBtn').onclick = (e) => { 
            e.preventDefault(); 
            if (state.isLocked) return;
            resetAutoLockTimer();

            const s = new Date(state.currentStartDate);
            const end = new Date(s.getFullYear(), s.getMonth()+1, 15);
            const weekChars = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            const holMap = Holidays.getMap(s, end);
            const att = getAtt();
            
            let datesList = '';
            let loop = new Date(s);
            
            while(loop <= end){ 
                const k = formatDateKey(loop); 
                if(state.wishLeaves[k] || att[k] === 'leave') { 
                    const day = loop.getDay();
                    const hol = holMap[k] ? ` ç¥æ—¥ï¼š${holMap[k]}` : '';
                    datesList += `ãƒ»${loop.getMonth()+1}/${loop.getDate()}(${weekChars[day]})${hol}\n`; 
                } 
                loop.setDate(loop.getDate()+1); 
            } 
            
            if(!datesList) {
                showAlert("å¸Œæœ›ä¼‘ã¾ãŸã¯æœ‰ä¼‘ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const email1 = state.settings.email1;
            const email2 = state.settings.email2;
            let toList = [];
            if (email1) toList.push(email1);
            if (email2) toList.push(email2);

            if (toList.length === 0) {
                showAlert("å®›å…ˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã€Œâš™ï¸ è¨­å®šã€ãƒœã‚¿ãƒ³ã‹ã‚‰é…è»Šä¿‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const senderName = state.settings.senderName ? `  ${state.settings.senderName}` : '';
            const subject = `å¸Œæœ›ä¼‘ç”³è«‹ ${end.getMonth()+1}æœˆåº¦${senderName}`;
            const body = `ãŠç–²ã‚Œæ§˜ã§ã™ã€‚\nä¸‹è¨˜ã«ã¦ã€ä¼‘ã¿ã‚’ã„ãŸã ããŸãç”³è«‹ã„ãŸã—ã¾ã™ã€‚\n\nã€${end.getMonth()+1}æœˆåº¦ ã€‘\n${datesList}\nãŠæ‰‹æ•°ã‚’ãŠã‹ã‘ã—ã¾ã™ãŒã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

            const dummy = document.createElement("textarea");
            document.body.appendChild(dummy);
            dummy.value = body;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);

            const mailtoUrl = `mailto:${toList.join(',')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            const ua = navigator.userAgent.toLowerCase();
            const isAppBrowser = ua.indexOf('line') > -1 || ua.indexOf('instagram') > -1;

            if (isAppBrowser) {
                const a = document.createElement('a');
                a.href = mailtoUrl;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => {
                    showAlert("ã€é‡è¦ã€‘\nLINEç­‰ã®ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªãŒæ­£å¸¸ã«èµ·å‹•ã›ãšã€ãƒ‡ãƒ¼ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\n\nå³ä¸‹ï¼ˆã¾ãŸã¯å³ä¸Šï¼‰ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãï¼ˆSafari/Chromeç­‰ï¼‰ã€ã‚’é¸æŠã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚\n\nâ€»ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€ã”è‡ªèº«ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦è²¼ã‚Šä»˜ã‘ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚");
                }, 1500);
            } else {
                window.location.href = mailtoUrl;
            }

            const msg = document.getElementById('copyStatusMsg');
            msg.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™\nï¼ˆæœ¬æ–‡ã¯ã‚³ãƒ”ãƒ¼æ¸ˆã¿ã§ã™ï¼‰';
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
        };

        ['Work','WishLeave','Leave','Off','PublicOff'].forEach(m => { 
            const id = 'mode' + m;
            const val = m.replace(/[A-Z]/g, l => '_' + l.toLowerCase()).replace(/^_/,''); 
            document.getElementById(id).onclick = () => { state.selectedMode = (state.selectedMode === val) ? null : val; render(); }; 
        });

        ['mousedown', 'touchstart', 'keydown'].forEach(evt => 
            document.addEventListener(evt, resetAutoLockTimer)
        );

        initDate(); render(); initFirebase(); 
    </script>
</body>
</html>